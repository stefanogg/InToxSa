---
title: "Growth curves analysis"
author: "Stefano Giulieri"
date: "02/03/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
msg <- stringr::str_c("My directory is ", here::here())
print(msg)
```

```{r}
library(tidyverse)
library(magrittr)
# rm(list = ls())
source("Functions/all_functions.R")
```

# Upload data

```{r}
df_growth <- read_csv("Data_parsing/parsed_experiments/exp190831/growth_data_plate2_exp190831.csv")
```

We need to decide whether we should standardise in relation to JE2. For now, we won't standardise because we are working on exp190831 only.

# Check for outliers

Here, we need to update the plotting function so that growth data can be plotted as well.

```{r}
plot_growth_curves(df = df_growth, annotate = T)
```

Some strains are heterogenous, but with only 3 replicates, we can't identify outliers reliably.

# Fit curves

Here, we fit growth curves using the same approach that we used for cell death dynamics. 

```{r}
df_growth_fit <- fit_smooth_spline(df = df_growth, growth_curves = T)
plot_growth_curves(df = df_growth_fit, fitted = T, draw_abline = T) 
# modify the function to add abline with max growth rate
```


# Extract parameters

```{r}
growth_parameters <- get_parameters(df = df_growth_fit, growth_curves = T) %>%
  # calculate doubling time
  # mutate(doubling_time = log(2)/max_death_rate) %>%
  filter(!sample_id %in% c("Complete lysis", "Non infected"))
df <- growth_parameters %>%
  mutate(x = str_c(strain_group, sample_id, sep = " / "))
df
param <- df %>%
  select(AUC:min_death_rate, doubling_time) %>%
  colnames()
df_long <- df %>%
  select(x, one_of(param)) %>%
  pivot_longer(cols = one_of(param), names_to = "parameter", values_to = "value")
for (i in param){
 df <- df_long %>%
   filter(parameter == i)
  p <- df %>%
  ggplot(aes(x = fct_rev(x), y = value)) +
  geom_boxplot() +
  coord_flip() +
  labs(title = i, x = "Sample") +
  theme_bw()
  print(p)
}

```

# Check for growth curves availability in the repository

```{r}
f <- list.files("Raw_data/", recursive = T) %>% str_subset("plate")
t <- tibble(exp = str_match(f, "(.*exp.*\\d{6})/")[,2]) %>%
  distinct()
s <- "Growth_curves"
f_gr <- str_subset(f, s)
str_split_fixed(f_gr, "/", n = 3)[,1:2]
t_gr <- tibble(exp1 = str_split_fixed(f_gr, 
                  "/", 
                  n = 3)[,1],
               exp2 = str_split_fixed(f_gr, 
                  "/", 
                  n = 3)[,2]) %>%
  unite(col = "exp", sep  = "/") %>%
  mutate(growth_curve_available = TRUE)

# t_gr <- tibble(exp = str_match(f_gr, "(plate.*/exp\\d*)/")[,2],
#                growth_curve_available = TRUE) 
t_gr_nogr <- t %>%
  left_join(t_gr) %>%
  replace_na(list(growth_curve_available = F))


```

# Concatenate available growth curves

```{r}
g <- list.files("Data_parsing/parsed_experiments", recursive = T, full.names = TRUE) %>% str_subset("growth")
all_g_data <- purrr::map(g, function(g){
  df <- read_csv(g) %>%
    mutate(plate = as.character(plate))
  return(df) 
}) %>%
  bind_rows() %>%
  cut_exp_duration()
# add whether normalised or not
t_norm <- all_g_data %>%
  group_by(plate, experiment) %>%
  summarise(normalised = unique(OD_blank_normalised)) %>%
  unite(col = "exp", plate, experiment, sep  = "/") %>%
  mutate(exp = str_c("plate", exp))
t_growth <- t_gr_nogr %>%
  mutate(exp = str_remove(exp, "_")) %>%
  left_join(t_norm)
# remove experiments with less than 40k cells
excluded_exp <- read_csv("Data_parsing/dataframes/concatenated_datasets/PI_kinetics_data.csv") %>%
  filter(cell_number != 4e4) %>%
  select(plate, experiment) %>%
  distinct() 
nrow(excluded_exp)
```

Experiments with cell number other than 40,000 were dropped from the dataset before saving. Since we haven't save all parsed data, we will guess.

``` {r}
included_exp <- read_csv("Data_parsing/dataframes/concatenated_datasets/PI_kinetics_data.csv") %>%
  filter(cell_number == 4e4) %>%
  select(plate, experiment) %>%
  distinct() %>%
  unite(col = "exp", plate, experiment, sep  = "/", remove = F) %>%
  mutate(exp = str_c("plate", exp)) %>%
  mutate(included = T)
t_growth_included_excluded <- t_growth %>%
  separate(exp, into = c("plate", "experiment"), sep = "/", remove = F) %>%
  mutate(plate = str_remove(plate, "plate")) %>%
  left_join(included_exp)
t_growth_included <- t_growth_included_excluded %>%
  mutate(included = if_else(!included & plate %in% c("2", "3") & str_detect(experiment, "exp19"),
                            F, T)) %>%
  filter(included) %>%
  select(exp, growth_curve_available, normalised)
write_csv(t_growth_included, "Data_analysis/tmp/t_growth_included.csv")
```

# Plot

```{r}
# plot_growth_curves(all_g_data, combine_experiments = "plate")
# for (i in unique(all_g_data$plate)){
#   df_plot <- filter(all_g_data, plate == i)
#   n_rep <- df_plot %>% filter(sample_id == "JE2") %>% .$well_id %>% n_distinct()
#   p <- plot_growth_curves(df_plot, print_plot = F, return_plots = T) +
#     labs(caption = str_c(n_rep, " replicates"))
#   print(p)
# }
dir <- "Data_analysis/tmp/g_data"
if (!dir.exists(dir)) dir.create(dir)
purrr::map(unique(all_g_data$experiment), function(i){
  df_plot <- filter(all_g_data %>% filter(!sample_id %in% c("Complete lysis", "Non infected")), experiment == i)
  n_rep <- df_plot %>% filter(sample_id == "JE2") %>% .$well_id %>% n_distinct()
  if (unique(df_plot$OD_blank_normalised)) {
    x <- "yes"
  } else {
    x <- "no"
  }
  s <- str_c("OD blank normalised: ", x)
  p <- plot_growth_curves(df_plot, print_plot = F, return_plots = T, combine_experiments = "none") +
    labs(subtitle = s)
  file <- str_c(dir, "/growth_data_plate_", unique(df_plot$plate), "_", i, ".pdf")
  ggsave(file, p)
  return()
})
# p <- patchwork::wrap_plots(p_list)
# ggsave("Data_analysis/tmp/all_g_data.pdf", p, width = 18, height = 10)

# p <- plot_growth_curves(all_g_data %>% filter(plate == "M2"), comparator = "JE2", return_plots = T, print_plot = F) +
#   labs(subtitle = "Comparator: JE2")
# ggsave("Data_analysis/tmp/plate_M2_g_data.pdf", p)

# JE2 only
all_g_data %>%
  filter(sample_id == "JE2") %>%
  plot_growth_curves(combine_experiments = "all", annotate = T)
```

# Save the concatenated dataframe

```{r}
all_g_data %>%
  write_csv("Data_analysis/dataframes/all_growth_data.csv")
```

