---
title: "Process parsed data"
author: "Stefano Giulieri"
date: "05/08/2020"
output: html_document
---

# Set/check knitR option and working directory

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
msg <- stringr::str_c("My directory is ", here::here())
message(msg)
```

# Library and functions

```{r}
library(tidyverse)
library(magrittr)
# rm(list = ls())
source("Functions/all_functions.R")
```

# Import all VANANZ PI and growth curve data (plate 1 to 6 + P1, P2, M1, M2, GP1, GP2, GP3)

nb experiment PI kinetics = 2
nb experiment growth curves = 15

```{r}

raw_PI.df <- read.csv("Data_analysis/dataframes/concatenated_checked/all_cell_death_data_parsed.csv")
sort(unique(raw_PI.df$experiment))
sort(unique(raw_PI.df$plate))
raw_PI.df %>% filter(!duplicated(experiment)) %>% count(plate, .drop = F)

  
raw_GC.df <- read.csv("Data_analysis/dataframes/concatenated_checked/growth_data_parsed.csv")
sort(unique(raw_GC.df$experiment))
unique(raw_GC.df$plate)
raw_GC.df %>% filter(!duplicated(experiment)) %>% count(plate, .drop = F)
raw_PI.df %>% filter(timepoint == 0 ) %>% count(experiment, .drop = F)
```

# Process PI kinetics data
## Check JE2 reference

```{r}
# Use stringent criteria for JE2 and plot outliers detected reduced prportion outlier default from 0.1 to 0.05
raw_PI_check <- raw_PI.df %>%
  check_reference(plot = TRUE,
                  outlier_sd_proportion = .1,
                  outlier_tukey_proportion = .1,
                  outlier_mad_proportion = .1,
                  filter = F)

# plot non outliers
raw_PI_check %>% 
  filter(outlier_curve == F) %>%
  plot_cell_death(standardized = T, fitted = T)

# plot outliers
raw_PI_check %>% 
  filter(outlier_curve == T) %>%
  plot_cell_death(standardized = T, fitted = T)

# get vector of outliers
JE2_out <- raw_PI_check %>% 
  filter(outlier_curve == T) %>%
  .$well_id %>%
  unique()
JE2_out

# allow easier visualisation of outliers wells
(raw_PI_check %>%
  plot_cell_death(standardized = T, fitted = T, highlight_well1 = str_subset(JE2_out, "M2"), return_plots = T, print_plot = F))[[2]] +
  geom_point(data = raw_PI_check %>% filter(well_id %in% str_subset(JE2_out, "M2")) %>% select(timepoint, f_signal = f_signal.fitted), colour = "#4dac26")

```

Based on JE2 outlier detection:
- plate 4 exp191120 will be excluded (=> plate 4 only one plate remaining)
- plate 4 and M2 will be kept but are problematic (only 1 plate remaining normalised with 1 JE2 reading only)
- other plates are fine

TO BE CHECKED

## Filter JE2 outliers, standardise and fit curves
```{r}
clean_PI.df <- raw_PI.df %>%
  filter(!well_id %in% JE2_out) %>%
  standardise_curves() %>%
  fit_curves() %>%
  get_derivatives(use_fitted = T) %>%
  flag_outlier_curves(filter = T) 
```

## Calclulate sample mean and median of kinetics
```{r}
mean_clean_PI_kinetics.df <- clean_PI.df %>%
  group_by(sample_id, timepoint) %>%
  summarise_all(funs(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) %>%
  ungroup()

median_clean_PI_kinetics.df <- clean_PI.df %>%
  group_by(sample_id, timepoint) %>%
  summarise_all(funs(if(is.numeric(.)) median(., na.rm = TRUE) else first(.))) %>%
  ungroup()
```

## Extract parameters and calculate means and medians of parameters
```{r}
parameters_PI.df <- clean_PI.df %>%
  get_parameters()

mean_sample_parameters_PI.df <- parameters_PI.df %>%
  group_by(sample_id) %>%
  summarise_all(funs(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) %>%
  ungroup()

median_sample_parameters_PI.df <- parameters_PI.df %>%
  group_by(sample_id) %>%
  summarise_all(funs(if(is.numeric(.)) median(., na.rm = TRUE) else first(.))) %>%
  ungroup()

```

## Merge with metadata and save files 
```{r}
# import strain metadata
strain_metadata.df <- read.csv("Ideas_Grant_2020_analysis/Raw_data/strain_metadata_with_controls.csv")

clean_PI.df <- merge(clean_PI.df, strain_metadata.df, by = "sample_id") %>%
  select(-strain_group.y) %>% rename(strain_group = strain_group.x)

mean_clean_PI_kinetics.df <- merge(mean_clean_PI_kinetics.df, strain_metadata.df, by = "sample_id") %>%
  select(-strain_group.y) %>% rename(strain_group = strain_group.x)

median_clean_PI_kinetics.df <- merge(mean_clean_PI_kinetics.df, strain_metadata.df, by = "sample_id") %>%
  select(-strain_group.y) %>% rename(strain_group = strain_group.x)

parameters_PI.df <- merge(parameters_PI.df, strain_metadata.df, by = "sample_id") %>%
  select(-strain_group.y) %>% rename(strain_group = strain_group.x)

mean_sample_parameters_PI.df <- merge(mean_sample_parameters_PI.df, strain_metadata.df, by = "sample_id") %>%
  select(-strain_group.y) %>% rename(strain_group = strain_group.x)

median_sample_parameters_PI.df <- merge(median_sample_parameters_PI.df, strain_metadata.df, by = "sample_id") %>%
  select(-strain_group.y) %>% rename(strain_group = strain_group.x)

# write.csv(clean_PI.df, "Data_analysis/processed_data/processed_PI_kinetics.csv", row.names=FALSE)
write.csv(mean_clean_PI_kinetics.df, "Data_analysis/processed_data/processed_mean_PI_kinetics.csv", row.names=FALSE)
write.csv(median_clean_PI_kinetics.df, "Data_analysis/processed_data/processed_median_PI_kinetics.csv", row.names=FALSE)
write.csv(parameters_PI.df, "Data_analysis/processed_data/processed_parameters_PI.csv", row.names=FALSE)
write.csv(mean_sample_parameters_PI.df, "Data_analysis/processed_data/processed_mean_parameters_PI.csv", row.names=FALSE)
write.csv(median_sample_parameters_PI.df, "Data_analysis/processed_data/processed_median_parameters_PI.csv", row.names=FALSE)
```

# Check VAN-176

```{r}
# clean_PI.df %>%
#   filter(strain_group == "VAN-176") %>%
#   plot_cell_death(standardized = T, fitted = T)
```


# Process growth curves data

## Reformat growth curve data in a PI kinetic like format
```{r}
# re import raw GC data
raw_GC.df <- read.csv("Data_analysis/dataframes/all_growth_data.csv")

# import strain metadata
strain_metadata.df <- read.csv("plate_info/strain_metadata_with_controls.csv")

# fix sample_id, strain_group, replicate, well_row, well_col using raw_PI.df
f <- list.files(c("plate_info", "Genetic_pairs_analysis_completed/plate_info"), pattern = "well_info", full.names = T)
info.df <- lapply(f, function(x) read_csv(x) %>% mutate(plate_number = as.character(plate_number)) ) %>%
  bind_rows() %>%
  rename(plate = plate_number)

clean_GC.df <- raw_GC.df %>%
  select(-sample_id, -strain_group, -replicate, -well_row, -well_col) %>%
  merge(., info.df, by = c("well", "plate"))

# minus blank for all measure
clean_GC.df <- clean_GC.df %>%
  filter(sample_id == "Complete lysis") %>%                   # Complete lysis <=> blank
  replace_na(list(OD = 0)) %>%                                # Fix NA values in OD
  group_by(timepoint, experiment) %>%
  summarise(blank_OD = mean(OD)) %>%                          # Calculate mean OD of blank
  ungroup() %>%
  merge(clean_GC.df, ., by = c("experiment", "timepoint")) %>%  # Merge with initial data
  replace_na(list(OD = 0)) %>%                                # Fix NA values in OD
  mutate(f_signal = OD - blank_OD) %>%                        # Minus blank to OD -> f_signal
  filter(sample_id != "Blank") %>%
  filter(sample_id != "Complete lysis") %>%
  select(-OD, -blank_OD, -OD_blank_normalised)
  
# remove experiment exp191107 with anormal low OD (max ~1.7)
clean_GC.df <- clean_GC.df %>%
  filter(experiment != "exp191107")

# filter duplicated value in single experiment (eg. exp191121)
clean_GC.df <- clean_GC.df %>%
  group_by(well_id, timepoint, f_signal) %>%
  filter(!duplicated(timepoint)) %>%
  ungroup()

# experiment exp190831 plate2 -> measure every 15 min instead of 10 => problem for fitting and AUC parameter)
# experiment exp191107 plate2 -> measure every 5 min instead of 10 => problem for fitting and AUC parameter)
# Keep only measure every 30 min for all experiments
clean_GC.df <- clean_GC.df %>%
  filter(divisible(timepoint,30))

```


## Save clean raw GC data
```{r}
  write.csv(x = clean_GC.df, row.names = F,
            file = "Data_analysis/dataframes/all_raw_growth_data_blank_normalised_cleaned.csv")
```



## Filter outlier GC

Compare with PI kinetics, testing shows hat spar (smoothnes of fit) need to be adjusted to avoid erroneous max growth rate due to local peaks:
spar = 0.4 seems good

min sd and outlier proportion need to be adjusted too:
min_sd = 1 (outlier sd according to tukey box plot)
outlier_xx_proportion = 0.01

```{r}
clean_GC.df <- clean_GC.df %>%
  cut_exp_duration() %>%
  fit_curves(use_standardised = F, spar = .4) %>%
  get_derivatives(spar = 0.4, use_fitted = T) %>%
  flag_outlier_curves(use_standardised = F, 
                      min_sd = 1, 
                      outlier_sd_proportion = 0.01, 
                      outlier_mad_proportion = 0.01, 
                      outlier_tukey_proportion = 0.01, 
                      filter = F ) 
```

## Plot curves + outliers
```{r eval=FALSE, fig.height=40, fig.width=15, include=FALSE}
# plot all raw with outliers
clean_GC.df %>% 
  plot_cell_death(standardized = F, fitted = F, all_replicates = 5,
                  highlight_well1 = clean_GC.df %>% filter(outlier_curve == T) %>% .$well_id,
                  highlight_point1 = "outlier_mad",
                  highlight_point2 = "outlier_tukey",
                  highlight_point3 = "outlier_sd")

# plot all fitted with outliers
clean_GC.df %>% 
  plot_cell_death(standardized = F, fitted = T, all_replicates = 5,
                  highlight_well1 = clean_GC.df %>% filter(outlier_curve == T) %>% .$well_id,
                  highlight_point1 = "outlier_mad",
                  highlight_point2 = "outlier_tukey",
                  highlight_point3 = "outlier_sd")

# plot all fitted without outliers
clean_GC.df %>% 
  filter(outlier_curve == F) %>%
  plot_cell_death(standardized = F, fitted = T, all_replicates = 5,
                  highlight_well1 = clean_GC.df %>% filter(outlier_curve == T) %>% .$well_id,
                  highlight_point1 = "outlier_mad",
                  highlight_point2 = "outlier_tukey",
                  highlight_point3 = "outlier_sd")

# plot all derivatives with outliers
clean_GC.df %>% 
  plot_cell_death(derivative1 = T, all_replicates = 5,
                  highlight_well1 = clean_GC.df %>% filter(outlier_curve == T) %>% .$well_id,
                  highlight_point1 = "outlier_mad",
                  highlight_point2 = "outlier_tukey",
                  highlight_point3 = "outlier_sd")


```

## Remove outliers
```{r}
clean_GC.df <- clean_GC.df %>%
  filter(outlier_curve != T)

# check nb of sample
length(unique(clean_GC.df$sample_id))
length(unique(raw_GC.df$sample_id))

# check missing sample before/after outliers filter
setdiff(clean_GC.df$sample_id, raw_GC.df$sample_id)
setdiff(raw_GC.df$sample_id, clean_GC.df$sample_id) 

# check concordance of sample between PI/GC
length(unique(clean_PI.df$sample_id))
length(unique(clean_GC.df$sample_id))

setdiff(clean_GC.df$sample_id, clean_PI.df$sample_id)
setdiff(clean_PI.df$sample_id, clean_GC.df$sample_id)
```

## Calclulate sample mean and median of GC
```{r}
mean_clean_GC_kinetics.df <- clean_GC.df %>%
  group_by(sample_id, timepoint) %>%
  summarise_all(funs(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) %>%
  ungroup()

median_clean_GC_kinetics.df <- clean_GC.df %>%
  group_by(sample_id, timepoint) %>%
  summarise_all(funs(if(is.numeric(.)) median(., na.rm = TRUE) else first(.))) %>%
  ungroup()
```

## Extract parameters and calculate means and medians of parameters
```{r}
# get parameters
parameters_GC.df <- clean_GC.df %>%
  get_parameters(.,use_fitted = F, spar = .4)

# rename parameters to differentiate from PI
parameters_GC.df <- parameters_GC.df %>%
  rename_all(funs(stringr::str_replace_all(., 'death', 'OD'))) 

# Calculate sample mean and median
mean_sample_parameters_GC.df <- parameters_GC.df %>%
  group_by(sample_id) %>%
  summarise_all(funs(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.))) %>%
  ungroup()

median_sample_parameters_GC.df <- parameters_GC.df %>%
  group_by(sample_id) %>%
  summarise_all(funs(if(is.numeric(.)) median(., na.rm = TRUE) else first(.))) %>%
  ungroup()
```


## merge parameter with kinetcis data and plot sorted by growth rate
```{r fig.height=30, fig.width=10}
# mean_clean_GC_kinetics.df %>% 
#   merge(., mean_sample_parameters_GC.df , by = "sample_id", all.x = T) %>%
#   mutate( sample_id = fct_reorder(sample_id,AUC_OD)) %>%
#   plot_cell_death(standardized = F, fitted = T, all_replicates = F)
```

## Merge with metadata and save files 
```{r}
strain_metadata.df <- read.csv("Ideas_Grant_2020_analysis/Raw_data/strain_metadata_with_controls.csv")


clean_GC.df <- merge(clean_GC.df, strain_metadata.df, by = "sample_id")
mean_clean_GC_kinetics.df <- merge(mean_clean_GC_kinetics.df, strain_metadata.df, by = "sample_id")
median_clean_GC_kinetics.df <- merge(mean_clean_GC_kinetics.df, strain_metadata.df, by = "sample_id")
parameters_GC.df <- merge(parameters_GC.df, strain_metadata.df, by = "sample_id")
mean_sample_parameters_GC.df <- merge(mean_sample_parameters_GC.df, strain_metadata.df, by = "sample_id")
median_sample_parameters_GC.df <- merge(median_sample_parameters_GC.df, strain_metadata.df, by = "sample_id")

write.csv(clean_GC.df, "Ideas_Grant_2020_analysis/Processed_data/processed_GC_kinetics.csv", row.names=FALSE)
write.csv(mean_clean_GC_kinetics.df, "Ideas_Grant_2020_analysis/Processed_data/processed_mean_GC_kinetics.csv", row.names=FALSE)
write.csv(median_clean_GC_kinetics.df, "Ideas_Grant_2020_analysis/Processed_data/processed_median_GC_kinetics.csv", row.names=FALSE)
write.csv(parameters_GC.df, "Ideas_Grant_2020_analysis/Processed_data/processed_parameters_GC.csv", row.names=FALSE)
write.csv(mean_sample_parameters_GC.df, "Ideas_Grant_2020_analysis/Processed_data/processed_mean_parameters_GC.csv", row.names=FALSE)
write.csv(median_sample_parameters_GC.df, "Ideas_Grant_2020_analysis/Processed_data/processed_median_parameters_GC.csv", row.names=FALSE)
```
