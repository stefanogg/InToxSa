---
title: "Cell death analysis"
author: "Stefano Giulieri"
date: "25/03/2020"
output: html_document
---

This is a script to concatenate all cell death dataframes in a single file and then perform data cleaning and data extraction steps. 


```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
msg <- stringr::str_c("My directory is ", here::here())
print(msg)
```

```{r}
library(tidyverse)
library(magrittr)
rm(list = ls())
source("Functions/all_functions.R")
```

# Concatenate available cell death data

## Check for available "single parsed" cell death dataframes

```{r}
c <- list.files("Data_parsing/parsed_experiments", recursive = T, full.names = TRUE) %>% str_subset("PI")
c
```

Ideally, we would use single parsed experiments here. We will catch up with the parsing of plates 1 to 6 at some point but for the moment we are happy to use already concatenated data. Note that **outliers were already removed**.

```{r}
c_data <- read_csv("Data_parsing/dataframes/concatenated_datasets/PI_kinetics_data.csv")
c_data %>%
  select(plate, experiment) %>%
  distinct()
```

Concatenated data contain all plates but M1 and M2. Note that for plate M1 we keep exp200309 only! We also need to remove outliers

```{r}
outliers <- list(
  M1 = str_c("exp200309_M1_", c("G11", "C04", "B04", "G10", "E12")),
  M2 = c("exp200313_M2_E04", "exp200313_M2_D12")
)
outliers <- Reduce(c, outliers)
c_to_add <- str_subset(c, "plateM")[c(2,3)] # remove first experiment for plate M1
c_data_to_add <- purrr::map(c_to_add, function(c){
  df <- read_csv(c) %>%
    mutate(plate = as.character(plate))
  return(df) 
}) %>%
  bind_rows() %>%
  filter(!well_id %in% outliers)

```

Now we concatenate all together

```{r}
all_c_data <- bind_rows(c_data, c_data_to_add)
write_csv(all_c_data,
          "Data_analysis/dataframes/all_cell_death_data_outliers_manually_removed.csv")
```

## Concatenated dataframe of parsed data without outlier filtering

```{r}
c_data_parsed <- read_csv("Data_parsing/dataframes/partial_datasets/all_PI_kinetics_well_info.csv") %>%
  mutate(plate = as.character(plate))
c_data_parsed %>%
  select(plate, experiment) %>%
  distinct()
c_to_add_parsed <- c(c_to_add, str_subset(c, "plateP"))
c_data_parsed_to_add <- purrr::map(c_to_add_parsed, function(c){
  df <- read_csv(c) %>%
    mutate(plate = as.character(plate))
  return(df) 
}) %>%
  bind_rows()
all_c_data_parsed <- bind_rows(c_data_parsed, c_data_parsed_to_add)
write_csv(all_c_data_parsed,
          "Data_analysis/dataframes/all_cell_death_data_parsed.csv")
```

## Concatenate single parsed dataframes (6 April 2020)

As of 6 April 2020, we have now parsed cell death data as single experiments that can now be concatenated.
We first generate a list of experiments to retain: basically all with 40k cells and after excluding problematic experiments.

```{r}
# all cell death data
all_c_data_raw <- purrr::map(c, function(c){
  df <- read_csv(c) %>%
    mutate(plate = as.character(plate))
}) %>%
  bind_rows()
# experiments with less than 40k cells
cells_low <- all_c_data_raw %>%
  filter(cell_number != 4e4) %>%
  select(plate, experiment) %>%
  distinct()
cells_low
# experiments excluded for other reasons: exp200228 (first experiment for plate M1)
all_c_data <- all_c_data_raw %>%
  filter(!experiment %in% c(cells_low$experiment, "exp200228"))
```

## Check concatenated file

```{r}
# included plates / experiments
all_c_data %>%
  select(plate, experiment) %>%
  distinct()
```

Two experiments (6 replicates) for each of plates 1-6 and one experiment (one replicate) for each of plates P1, P2, M1, M2

```{r}
# Number of wells per experiment
all_c_data %>%
  group_by(plate, experiment) %>%
  summarise(n_wells = n_distinct(well))
```

We have now confirmed that the concatenated dataframe includes all experiments of interest and the all wells have been parsed.

```{r}
write_csv(all_c_data,
          "Data_analysis/dataframes/concatenated_checked/all_cell_death_data_parsed.csv")
```

## Remove outliers manually

Outliers were identified manually in plates 1-6 and plates M1-M2. No outliers were identified in plates P1 and P2.
Here, we create a complete dataframe of manually identified outliers

```{r}
# plates 1-6
JE2.outliers <- tibble(sample_id = "JE2",
                       well_id = c("exp191121_4_B06", "exp191121_4_D06"))
df_outliers_plates1_6 <- read_csv("Data_analysis/outliers/PI_kinetics_VANANZ_outliers_plates1_6.csv") %>%
  bind_rows(JE2.outliers)

# plates M1-M2
outliers_platesM1_M2 <- tibble(well_id = c(str_c("exp200309_M1_", c("G11", "C04", "B04", "G10", "E12")),
                               c("exp200313_M2_E04", "exp200313_M2_D12"))) %>%
  left_join(all_c_data %>% select(well_id, sample_id) %>% distinct())

# all outliers
df_outliers <- df_outliers_plates1_6 %>%
  bind_rows(outliers_platesM1_M2)

# save
write_csv(df_outliers,
          "Data_analysis/outliers/PI_data_VANANZ_outliers.csv")
```

## Concatenated dataframes, outliers removed manually

```{r}
all_c_data_outliers_removed <- all_c_data %>%
  filter(!well_id %in% df_outliers$well_id)

# save
write_csv(all_c_data_outliers_removed,
          "Data_analysis/dataframes/concatenated_checked/all_cell_death_data_outliers_manually_removed.csv")
```

