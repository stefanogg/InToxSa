---
title: "PCA_analysis_VANANZ"
author: "R Guerillot"
date: "03/03/2020"
output: html_document
---

# Set/check knitR option and working directory
```{r setup, include=T}
library(tidyverse)
library(here)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here())
print(paste("My working directory is:" ,here()))
```

# import/normalise/fit PI data
We need to use the exact same partial dataset that have been use for visual outlier detection by Stefano. Otherwise outlier detection will be impacted by the non visually assesed experiments.

As for this analysis:
title: "Analysis of plate 1-6 of the VANANZ collection"
author: "Stefano Giulieri"
date: "13/01/2020"

We will:
- import a partial PI kinetics dataset
- remove 2 JE2 wells
- remove experiments where outlier have not been visually assessed.
```{r}
source("Functions/all_functions.R")

JE2.outliers <- c("exp191121_4_B06", "exp191121_4_D06")

all_PI.df <- read.csv("Data_parsing/dataframes/partial_datasets/all_PI_kinetics_well_info.csv") %>%
  #filter(!(well_id %in% JE2.outliers)) %>%
  #filter(experiment %in% c("exp191116", "exp191107", "exp190831", "exp191109", "exp191121", "exp191120", "exp191129", "exp191205", "exp191206")) %>% # keep only the experiments where outliers have been visually assessed
  JE2_POMS_standardisation(.) %>%
  fit_smooth_spline(.)

```


# Summarise proportion of outliers for each well automatically using all methods (mad, sd, tukey) with default threshold
```{r}
all_PI_flagged_out.df <- all_PI.df %>% flag_outlier_timepoints(k_sd = 3, k_mad = 3, k_tukey = 1.5)
all_PI_outliers.df <- all_PI_flagged_out.df %>% summarise_outlier()
```

# Add Stefano's visual identifications of outliers to automatic outlier df
```{r}
visual_outliers <- read_csv("Data_analysis/outliers/PI_kinetics_VANANZ_outliers.csv")$well_id
visual_outliers

all_PI_outliers_plus_vis_out.df <- all_PI_outliers.df %>%
  mutate(vis_outlier = (well_id %in% visual_outliers))
```

# Plots to detect which method best fit visual detection
```{r}
ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_sd))+
  geom_jitter()

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_mad))+
  geom_jitter()

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_tukey))+
  geom_jitter()
```
Conclusion:
With default threshold sd method don't match visual identification, mad and tukey match very poorly too

# Can we combine mad and tukey proportion threshold
```{r}
ggplot(all_PI_outliers_plus_vis_out.df, aes(x=proportion_outlier_mad, y = proportion_outlier_tukey, color = vis_outlier))+
  geom_jitter(alpha = .2) +
  geom_vline(xintercept = .2) +
  geom_hline(yintercept = .2)

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=proportion_outlier_mad, y = proportion_outlier_tukey, color = vis_outlier))+
  geom_jitter(alpha = .2) +
  geom_vline(xintercept = .2) +
  geom_hline(yintercept = .2) +
  xlim(0,0.2) +
  ylim(0,0.2)
```
A threshold of >20% outlier with either tukey and mad method would remove most of visually identified outliers but not all.
It will also significantly increase the number of outlier 

# Try same thing with less stringent definition of outlier point
# Summarise proportion of outliers for each well automatically using all methods (mad, sd, tukey) with more stringent threshold
```{r}
all_PI_outliers.df <- all_PI.df %>% summarise_outlier(k_sd = 2, k_mad = 2, k_tukey = 1)
```

# Add Stefano's visual identifications of outliers to automatic outlier df
```{r}
visual_outliers <- read_csv("Data_analysis/outliers/PI_kinetics_VANANZ_outliers.csv")$well_id
visual_outliers

all_PI_outliers_plus_vis_out.df <- all_PI_outliers.df %>%
  mutate(vis_outlier = (well_id %in% visual_outliers))
```

# Plots to detect which method best fit visual detection
```{r}
ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_sd))+
  geom_jitter()

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_mad))+
  geom_jitter()

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_tukey))+
  geom_jitter()
```

# Can we combine mad and tukey proportion threshold
```{r}
ggplot(all_PI_outliers_plus_vis_out.df, aes(x=proportion_outlier_mad, y = proportion_outlier_tukey, color = vis_outlier))+
  geom_jitter(alpha = .2) +
  geom_vline(xintercept = .2) +
  geom_hline(yintercept = .2)

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=proportion_outlier_mad, y = proportion_outlier_tukey, color = vis_outlier))+
  geom_jitter(alpha = .2) +
  geom_vline(xintercept = .2) +
  geom_hline(yintercept = .2) +
  xlim(0,0.2) +
  ylim(0,0.2)
```

# Try again with a more stringent definition of outlier point
# Summarise proportion of outliers for each well automatically using all methods (mad, sd, tukey) with more stringent threshold
```{r}
all_PI_outliers.df <- all_PI.df %>% summarise_outlier(k_sd = 4, k_mad = 6, k_tukey = 4)
```

# Add Stefano's visual identifications of outliers to automatic outlier df
```{r}
visual_outliers <- read_csv("Data_analysis/outliers/PI_kinetics_VANANZ_outliers.csv")$well_id
visual_outliers

all_PI_outliers_plus_vis_out.df <- all_PI_outliers.df %>%
  mutate(vis_outlier = (well_id %in% visual_outliers))
```

# Plots to detect which method best fit visual detection
```{r}
ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_sd))+
  geom_jitter()

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_mad))+
  geom_jitter()

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_tukey))+
  geom_jitter()
```

# Can we combine mad and tukey proportion threshold
```{r}
ggplot(all_PI_outliers_plus_vis_out.df, aes(x=proportion_outlier_mad, y = proportion_outlier_tukey, color = vis_outlier))+
  geom_jitter(alpha = .2) +
  geom_vline(xintercept = .2) +
  geom_hline(yintercept = .2)

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=proportion_outlier_mad, y = proportion_outlier_tukey, color = vis_outlier))+
  geom_jitter(alpha = .2) +
  geom_vline(xintercept = .2) +
  geom_hline(yintercept = .2) +
  xlim(0,0.2) +
  ylim(0,0.2)

table(all_PI_outliers_plus_vis_out.df$proportion_outlier_mad > .1, all_PI_outliers_plus_vis_out.df$vis_outlier)

table(all_PI_outliers_plus_vis_out.df$proportion_outlier_tukey > .1, all_PI_outliers_plus_vis_out.df$vis_outlier)
```
It seems not possible to find parameters that accurately detect what have been considered has outlier visually

I have also added plotting options that helped for testing oulier detection threshold
see below arguments: 

highlight_well1
highlight_well2
highlight_point1
highlight_point2

# Highligth outliers curve on plot
```{r}
all_PI_outliers_flag.df <- all_PI.df %>% flag_outlier_timepoints(k_sd = 3, k_mad = 3, k_tukey = 1.5)
plot_cell_death(df = all_PI_outliers_flag.df %>% 
                  filter(plate == 6),
                standardized = T,
                combine_experiments = "all", 
                comparator = "JE2",
                highlight_well1 = visual_outliers,
                highlight_point1 = "outlier_tukey",
                highlight_point2 = "outlier_mad",
                fitted = T)
```
Automatic outlier detection identify too many outliers. We want to ignore outliers when replicates are very tights.

I have added a min_sd threshold to retain outliers when standard deviation between replicate is low.

# Checking sd distribution to define a min_sd threshold for outlier filtering
```{r}
ggplot(all_PI_outliers_flag.df, aes(x = sd, fill = as.factor(plate))) +
  geom_density(position = "stack")
```

We will keep the tail of the distribution:  min_sd > 20
```{r}
ggplot(all_PI_outliers_flag.df, aes(x = sd, fill = as.factor(plate))) +
  geom_density(position = "stack") +
  geom_vline(xintercept = .20)

ggplot(all_PI_outliers_flag.df, aes(x = sd, fill = as.factor(plate))) +
  geom_density(position = "stack") +
  geom_vline(xintercept = .20) +
  facet_wrap(~plate)
```

# Re-flag outliers using min_sd = 0.20
```{r}
all_PI_outliers_flag2.df <- all_PI.df %>% flag_outlier_timepoints(k_sd = 3, k_mad = 3, k_tukey = 1.5, min_sd = 0.20)
```

# Plot detected outliers with the 3 different methods and with the min_sd > 0.20 filter
```{r}

plot_cell_death(df = all_PI_outliers_flag2.df %>% 
                  filter(plate == 1),
                standardized = T,
                combine_experiments = "all", 
                comparator = "JE2",
                highlight_point1 = "outlier_sd",
                highlight_well1 = visual_outliers,
                fitted = T)

plot_cell_death(df = all_PI_outliers_flag2.df %>% 
                  filter(plate == 1),
                standardized = T,
                combine_experiments = "all", 
                comparator = "JE2",
                highlight_point1 = "outlier_mad",
                highlight_well1 = visual_outliers,
                fitted = T)

plot_cell_death(df = all_PI_outliers_flag2.df %>% 
                  filter(plate == 1),
                standardized = T,
                combine_experiments = "all", 
                comparator = "JE2",
                highlight_point1 = "outlier_tukey",
                highlight_well1 = visual_outliers,
                fitted = T)

```

# Count number of well if we exclude well with 10% outlier point

```{r}

out_sd <- all_PI_outliers_flag2.df %>%
  filter(outlier_sd == T) %>%
  group_by(well_id) %>%
  summarise(out_well_count = n(), prop_curve_out = n()/193) %>%
  filter(prop_curve_out > .1) %>%
  .$well_id

out_mad <- all_PI_outliers_flag2.df %>%
  filter(outlier_mad == T) %>%
  group_by(well_id) %>%
  summarise(out_well_count = n(), prop_curve_out = n()/193) %>%
  filter(prop_curve_out > .1) %>%
  .$well_id
  
out_tukey <- all_PI_outliers_flag2.df %>%
  filter(outlier_tukey == T) %>%
  group_by(well_id) %>%
  summarise(out_well_count = n(), prop_curve_out = n()/193) %>%
  filter(prop_curve_out > .1) %>%
  .$well_id

# total nb of well_id
length(unique(all_PI_outliers_flag2.df$well_id))

# total nb of well with >10% of timepoint outliers with sd method
length(out_sd)

# total nb of well with >10% of timepoint outliers with tukey method
length(out_tukey)

# total nb of well with >10% of timepoint outliers with mad method
length(out_mad)

# total nb of well with >10% of timepoint outliers with sd + tukey + mad methods
length(unique(c(out_sd, out_mad, out_tukey)))
length(unique(c(out_mad, out_tukey)))

# proportion of well considered outliers if all medod is used with >20% timepoint
length(unique(c(sd,out_mad, out_tukey)))/length(unique(all_PI_outliers_flag2.df$well_id))

```

Sd method detect only 1 outlier which is also identified by mad and tukey.
If we use all method with standard k (3 for sd, 3 for mad, 1.5 for tukey), > 0.2 sd (=20% of max JE2) and > 10% curve is outlier:
59 well_id among 1141 are excluded (~5%)

# plot all automatically detected outlier using these parameters
# green label = visually detected outliers
# purple label = automatically detected outliers
# green point = mad outliers
# purple point = tukey outliers

```{r fig.height=60, fig.width=15}
all_PI_outliers_plus_vis_out.df <- all_PI.df %>% summarise_outlier(k_sd = 3, k_mad = 3, k_tukey = 1.5, min_sd = 0.2) %>%
  mutate(vis_outlier = (well_id %in% visual_outliers)) %>%
  mutate(aut_outlier = (proportion_outlier_sd > .1 | proportion_outlier_mad > .1 |proportion_outlier_tukey > .1))

auto_outliers <- all_PI_outliers_plus_vis_out.df %>%
  filter(aut_outlier == T) %>%
  .$well_id

plot_cell_death(df = all_PI_outliers_flag2.df,
                standardized = T,
                combine_experiments = "all", 
                comparator = "JE2",
                highlight_well1 = visual_outliers,
                highlight_well2 = auto_outliers,
                highlight_point1 = "outlier_mad",
                highlight_point2 = "outlier_tukey",
                save_plot = "Automatic_outlier_detection_k_default_min_sd_.2_prop_.1",
                fitted = T,
                plot_size = c(15,40))

```


# Check concordance with visual detection:

```{r}

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_sd))+
  geom_jitter()

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_mad))+
  geom_jitter()

ggplot(all_PI_outliers_plus_vis_out.df, aes(x=vis_outlier, y = proportion_outlier_tukey))+
  geom_jitter()

table(all_PI_outliers_plus_vis_out.df$proportion_outlier_mad > .1, all_PI_outliers_plus_vis_out.df$vis_outlier)

table(all_PI_outliers_plus_vis_out.df$proportion_outlier_tukey > .1, all_PI_outliers_plus_vis_out.df$vis_outlier)
```

# Test new functions to reanalise all data from scratch
```{r}
all_PI.df <- read.csv("Data_parsing/dataframes/partial_datasets/all_PI_kinetics_well_info.csv")
JE2_out <- check_reference(all_PI.df)

JE2_well_out = JE2_out %>%
  filter(outlier_curve == T) %>%
  .$well_id %>%
  as.character() %>%
  unique()

all_PI_clean.df <- all_PI.df %>%
  filter(!(well_id %in% JE2_well_out)) %>%
  standardise_curves() %>%
  fit_curves() 
  
all_PI_clean.df %>% flag_outlier_curves(plot = F)

```



