---
title: "Identify significant PI changes across all pairs"
author: "Romain Guerillot"
date: "05/03/2020"
output: html_document
---

Aim: Identify significant AUC GC changes across all pairs with < 200 new core snp with wilcox.test

# Set/check knitR option and working directory

```{r setup, include=T}
library(tidyverse)
library(ggpubr)
library(here)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here())
setwd(here())
print(paste("My working directory is:" ,here()))
rm(list = ls())
```


# Import PI samples AUC
```{r}
PI_AUC.df <- readRDS("Genetic_pairs_analysis_Oct_2020/processed_data/PI/dataframes/parameters/PI_parameters.Rda") %>%
  select(well_id, sample_id, AUC_death) %>%
  mutate(sample_id = ifelse(sample_id == "TOX-4", yes = "BPH3757", no = as.character(sample_id))) %>% 
  filter(grepl(pattern = "BPH", sample_id))
```

# Import all genetic pairs metadata (with new distances from Compile_all_genetic_pairs_metadata..) 
```{r}
genetic_pairs_meta.df <- readRDS("Genetic_pairs_analysis_Oct_2020/processed_data/snippy/df_all_pairs_distances_metadata.Rda") 
```

# Select close pairs of isolates with new core snp distance < 200
```{r}
genetic_pairs_meta.df <- genetic_pairs_meta.df %>%
  filter(dist_new < 200)
```

# For each pairs (PAIR_ID) do wilcox.test using all replicates AUC measurement and calculate delta(mean_AUC)
```{r warning=FALSE}
datalist <- list()
for (i in 1:nrow(genetic_pairs_meta.df)){
  dat <- data.frame(i=i)
  pairid <- genetic_pairs_meta.df$pair_id[i]
  iso1 <- genetic_pairs_meta.df$iso1[i]
  iso2 <- genetic_pairs_meta.df$iso2[i]
  PI.df <- PI_AUC.df %>%
    filter(sample_id %in% c(iso1, iso2))
  print(pairid)
  
  if (length(unique(PI.df$sample_id)) < 2) {
    dat$pair_id <- pairid
    dat$iso1_AUC_death_mean <- NA
    dat$iso2_AUC_death_mean <- NA
    dat$delta_AUC_death <- NA
    dat$iso1_AUC_death_n_replicate <- NA
    dat$iso2_AUC_death_n_replicate <- NA
    dat$delta_AUC_death_pval <- NA
    datalist[[i]] <- dat
    next
  }
  # Calculate delta AUC PI of means
  PI_AUC_summary <- PI.df %>%
    group_by(sample_id) %>%
    summarise(AUC_mean = mean(AUC_death), n_PI_replicate = n()) %>%
    ungroup()
  
  PI_AUC_sum_iso1 <- PI_AUC_summary %>%
    filter(sample_id ==  iso1)
  PI_AUC_sum_iso2 <- PI_AUC_summary %>%
    filter(sample_id ==  iso2)

  AUC_mean_iso1 <- PI_AUC_sum_iso1$AUC_mean
  AUC_mean_iso2 <- PI_AUC_sum_iso2$AUC_mean
  
  AUC_repl_iso1 <- PI_AUC_sum_iso1$n_PI_replicate
  AUC_repl_iso2 <- PI_AUC_sum_iso2$n_PI_replicate
  
  delta_AUC <- AUC_mean_iso2 - AUC_mean_iso1
  
  pval <- compare_means(data = PI.df,
                formula =  AUC_death ~ sample_id,
                ref.group = iso1,
                method = "wilcox.test") %>%
    .$p
  
  dat$pair_id <- pairid
  dat$iso1_AUC_death_mean <- AUC_mean_iso1
  dat$iso2_AUC_death_mean <- AUC_mean_iso2
  dat$delta_AUC_death <- delta_AUC
  dat$iso1_AUC_death_n_replicate <- AUC_repl_iso1
  dat$iso2_AUC_death_n_replicate <- AUC_repl_iso2
  dat$delta_AUC_death_pval <- pval
  datalist[[i]] <- dat
  print(i)
}

# Combine results
genetic_pairs_AUC_death_stats.df <- do.call(rbind,datalist) 

# Merge with metadata
genetic_pairs_AUC_death_stats.df <- merge(genetic_pairs_AUC_death_stats.df,
                                          genetic_pairs_meta.df,
                                          by = "pair_id", all.x = T) %>%
  select(-i) %>%
  distinct()


# Generate non-symetric pairs df (decrease AUC)
genetic_pairs_decrease_AUC_death_stats.df <- genetic_pairs_AUC_death_stats.df %>%
  filter(delta_AUC_death > 0)

# # Multiple testing correction
# genetic_pairs_decrease_AUC_death_stats.df$delta_AUC_death_FDR <- p.adjust( genetic_pairs_decrease_AUC_death_stats.df$delta_AUC_death_pval, method = "fdr")
# 
# # Annotate significant AUC changes
# genetic_pairs_decrease_AUC_death_stats.df <- genetic_pairs_decrease_AUC_death_stats.df %>%
#   mutate(delta_AUC_death_significant = ifelse(delta_AUC_death_FDR < 0.05, yes = "significant", no = "not significant"))
# 
# # Extract FDR significance threshold
# FDR_ths <- genetic_pairs_decrease_AUC_death_stats.df%>% filter(delta_AUC_death_significant == "not significant") %>% .$delta_AUC_death_pval %>% min()
# 
# # Annotate significant on all pairs
# genetic_pairs_AUC_death_stats.df <- genetic_pairs_AUC_death_stats.df %>%
#   mutate(FDR_significance_threshold = FDR_ths) %>%
#   mutate(delta_AUC_death_significant = ifelse(delta_AUC_death_pval < FDR_ths, yes = "significant", no = "not significant"))

```

```{r}
saveRDS(object = genetic_pairs_AUC_death_stats.df, file = "Genetic_pairs_analysis_Oct_2020/processed_data/PI/dataframes/parameters/genetic_pairs_AUC_death_stats.Rda")
saveRDS(object = genetic_pairs_decrease_AUC_death_stats.df, file = "Genetic_pairs_analysis_Oct_2020/processed_data/PI/dataframes/parameters/genetic_pairs_decrease_AUC_death_stats.Rda")
```

# Summary plot
```{r}
ggplot(genetic_pairs_decrease_AUC_death_stats.df, aes(x = delta_AUC_death,
                                                      y = -log10(delta_AUC_death_pval),
                                                      colour = dist_new))+
  geom_point(alpha = .5) +
  theme_bw() +
  scale_color_viridis_c()

```



