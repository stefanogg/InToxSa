---
title: "Convergence analysis NEB mutant selection: special annotations"
author: "Romain Guerillot, Stefano Giulieri"
date: "08/03/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
setwd(here::here())
print(paste("My working directory is:" ,here::here()))
```

```{r message=F}
library(tidyverse)
rm(list = ls())
```

# Import convergent special annotations associated with mortality, cell death and growth

```{r}
df_conv_mort <- read.csv("Genetic_pairs_analysis_Oct_2020/processed_data/convergence/mortality/mortality_convergent_special_annot.csv") %>%
  mutate(conv_type = "mortality") %>%
  mutate(type_n_events = paste0("mortality:", as.character(n_events)))

df_conv_PI <- read.csv("Genetic_pairs_analysis_Oct_2020/processed_data/convergence/PI/PI_convergent_special_annot.csv") %>%
  mutate(conv_type = "PI") %>%
  mutate(type_n_events = paste0("PI:", as.character(n_events)))

df_conv_GC <- read.csv("Genetic_pairs_analysis_Oct_2020/processed_data/convergence/GC_no_stats/GC_convergent_special_annot.csv")  %>%
  mutate(conv_type = "GC") %>%
  mutate(type_n_events = paste0("GC:", as.character(n_events)))
```

# Get all NEB mutants with >=2 convergent event in at least one category (convergent PI, convergent GC, convergent mortality)
```{r}

all_convergent_special_annot.df <- rbind(df_conv_PI, df_conv_GC, df_conv_mort) %>%
  filter(n_events > 1) %>%
  group_by(feature_type, FEATURE_ID, NCTC8325_chrom, START_promoter, END_promoter) %>%
  mutate(total_conv_events = sum(n_events)) %>%
  mutate(all_mutations = paste0(unique(MUTATION), collapse = ",")) %>%
  mutate(conv_summary = paste0(type_n_events, collapse = ",")) %>%
  select(-n_events, -type_n_events, -conv_type) %>%
  distinct() %>%
  select(total_conv_events, conv_summary, everything()) %>%
  arrange(-total_conv_events) 
```

# Import convergent special annotations associated with mortality, cell death and growth

```{r}
df_conv_mort_operons <- read.csv("Genetic_pairs_analysis_Oct_2020/processed_data/convergence/mortality/mortality_convergent_operons.csv") %>%
  mutate(conv_type = "mortality") %>%
  mutate(type_n_events = paste0("mortality:", as.character(n_events)))

df_conv_PI_operons <- read.csv("Genetic_pairs_analysis_Oct_2020/processed_data/convergence/PI/PI_convergent_operons.csv") %>%
  mutate(conv_type = "PI") %>%
  mutate(type_n_events = paste0("PI:", as.character(n_events)))

df_conv_GC_operons <- read.csv("Genetic_pairs_analysis_Oct_2020/processed_data/convergence/GC_no_stats/GC_convergent_operons.csv")  %>%
  mutate(conv_type = "GC") %>%
  mutate(type_n_events = paste0("GC:", as.character(n_events)))
```

# Get all NEB mutants with >=2 convergent event in at least one category (convergent PI, convergent GC, convergent mortality)
```{r}

all_convergent_operons.df <- rbind(df_conv_PI_operons, df_conv_GC_operons, df_conv_mort_operons) %>%
  filter(n_events > 1) %>%
  group_by(operon_id, operon_label, operon_locus_tags, NCTC8325_chrom, BeginTU, EndTUshort) %>%
  mutate(total_conv_events = sum(n_events)) %>%
  mutate(mutated_features = str_c(unique(unlist(str_split(mutated_features, ","))), collapse = ",")) %>%
  mutate(mutated_features_types = str_c(unique(unlist(str_split(mutated_features_types, ","))), collapse = ",")) %>%
  mutate(mutated_genes = str_c(unique(unlist(str_split(mutated_genes, ","))), collapse = ",")) %>%
  mutate(conv_summary = paste0(type_n_events, collapse = ",")) %>%
  select(-n_events, -type_n_events, -conv_type) %>%
  distinct() %>%
  select(total_conv_events, conv_summary, everything()) %>%
  arrange(-total_conv_events) 
```



# Write files
```{r}
write.csv(all_convergent_special_annot.df, "Genetic_pairs_analysis_Oct_2020/processed_data/convergence/all_convergent_special_annot_df.csv", row.names = F)
write.csv(all_convergent_operons.df, "Genetic_pairs_analysis_Oct_2020/processed_data/convergence/all_convergent_operons_df.csv", row.names = F)
```

