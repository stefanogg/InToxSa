---
title: "Convergence analysis NEB mutant selection"
author: "Romain Guerillot"
date: "08/03/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
setwd(here::here())
print(paste("My working directory is:" ,here::here()))
```

```{r message=F}
library(tidyverse)
rm(list = ls())
```

# Import convergent genes associated with mortality, cell death and growth

```{r}
df_conv_mort <- read.csv("Genetic_pairs_analysis_Oct_2020/processed_data/convergence/mortality/mortality_convergent_genes.csv") %>%
  mutate(conv_type = "mortality") %>%
  mutate(type_n_events = paste0("mortality:", as.character(n_events)))

df_conv_PI <- read.csv("Genetic_pairs_analysis_Oct_2020/processed_data/convergence/PI/PI_convergent_genes.csv") %>%
  mutate(conv_type = "PI") %>%
  mutate(type_n_events = paste0("PI:", as.character(n_events)))

df_conv_GC <- read.csv("Genetic_pairs_analysis_Oct_2020/processed_data/convergence/GC_no_stats/GC_convergent_genes_no_stats.csv")  %>%
  mutate(conv_type = "GC") %>%
  mutate(type_n_events = paste0("GC:", as.character(n_events)))
```

# Get all NEB mutants with >=2 convergent event in at least one category (convergent PI, convergent GC, convergent mortality)
```{r}

all_convergent_genes.df <- rbind(df_conv_PI, df_conv_GC, df_conv_mort) %>%
  filter(n_events > 1) %>%
  merge(., 
        read.csv("Genetic_pairs_analysis_Oct_2020/metadata/NTML_384-well_Array_well_identification.csv"),
        by.x = "neb_mutant_id",
        by.y = "Strain.Name", 
        all.x = T) %>%
  filter(!is.na(product_prokka)) %>%
  group_by(cdhit_group) %>%
  mutate(total_conv_events = sum(n_events)) %>%
  mutate(all_mutations = paste0(mutations, collapse = ",")) %>%
  mutate(conv_summary = paste0(type_n_events, collapse = ",")) %>%
  mutate(product_prokka = paste0(product_prokka, collapse = ",")) %>%
  select(-n_events, -mutations, -type_n_events, -conv_type, -gene_prokka) %>%
  distinct() %>%
  select(total_conv_events, conv_summary, everything()) %>%
  arrange(-total_conv_events) 

all_convergent_neb.df <- all_convergent_genes.df %>%
  filter(!is.na(neb_mutant_id)) %>%
  select(total_conv_events, conv_summary, everything()) %>%
  arrange(-total_conv_events) 
```

# Write files
```{r}
# write.csv(all_convergent_genes.df, "Genetic_pairs_analysis_Oct_2020/processed_data/convergence/all_convergent_genes_df.csv", row.names = F)
# write.csv(all_convergent_neb.df, "Genetic_pairs_analysis_Oct_2020/processed_data/convergence/all_convergent_genes_neb_df.csv", row.names = F)
```

# Venn diagram of convergent event >1 in each category

```{r}
# Load library
library(VennDiagram)
 
# Generate 3 sets of 200 words
Mortality <- df_conv_mort %>% filter(!is.na(cdhit_group)) %>% filter(n_events >1) %>% .$cdhit_group %>% unique()
PI <- df_conv_PI %>% filter(!is.na(cdhit_group)) %>% filter(n_events >1) %>% .$cdhit_group %>% unique()
GC <- df_conv_GC %>% filter(!is.na(cdhit_group)) %>% filter(n_events >1) %>% .$cdhit_group %>% unique()

# Prepare a palette of 3 colors with R colorbrewer:
library(RColorBrewer)
myCol <- brewer.pal(3, "Pastel2")

# Chart
venn.diagram(
        x = list(Mortality, PI, GC),
        category.names = c("Mortality" , "Cell death" , "Growth"),
        filename = 'Genetic_pairs_analysis_Oct_2020/figures/convergence_venn_diagramm.png',
        output=TRUE,
        
        # Output features
        imagetype="png" ,
        height = 480 , 
        width = 480 , 
        resolution = 300,
        compression = "lzw",
        
        # Circles
        lwd = 2,
        lty = 'blank',
        fill = myCol,
        
        # Numbers
        cex = .6,
        fontface = "bold",
        fontfamily = "sans",
        
        # Set names
        cat.cex = 0.6,
        cat.fontface = "bold",
        cat.default.pos = "outer",
        cat.pos = c(-27, 27, 135),
        cat.dist = c(0.055, 0.055, 0.085),
        cat.fontfamily = "sans",
        rotation = 1
)
```


# Venn diagram of all mutations

```{r}
# Load library
library(VennDiagram)
 
# Generate 3 sets of 200 words
Mortality <- df_conv_mort %>% filter(!is.na(cdhit_group))  %>% .$cdhit_group %>% unique()
PI <- df_conv_PI %>% filter(!is.na(cdhit_group))  %>% .$cdhit_group %>% unique()
GC <- df_conv_GC %>% filter(!is.na(cdhit_group))  %>% .$cdhit_group %>% unique()

# Prepare a palette of 3 colors with R colorbrewer:
library(RColorBrewer)
myCol <- brewer.pal(3, "Pastel2")

# Chart
venn.diagram(
        x = list(Mortality, PI, GC),
        category.names = c("Mortality" , "Cell death" , "Growth"),
        filename = 'Genetic_pairs_analysis_Oct_2020/figures/all_mutations_venn_diagramm.png',
        output=TRUE,
        
        # Output features
        imagetype="png" ,
        height = 480 , 
        width = 480 , 
        resolution = 300,
        compression = "lzw",
        
        # Circles
        lwd = 2,
        lty = 'blank',
        fill = myCol,
        
        # Numbers
        cex = .6,
        fontface = "bold",
        fontfamily = "sans",
        
        # Set names
        cat.cex = 0.6,
        cat.fontface = "bold",
        cat.default.pos = "outer",
        cat.pos = c(-27, 27, 135),
        cat.dist = c(0.055, 0.055, 0.085),
        cat.fontfamily = "sans",
        rotation = 1
)
```

<<<<<<< Updated upstream
=======
# Selection of convergent NEB mutants to test with the operetta

We will use:
- all mutant with toatal convergence >=3 
- all PI convergence >=2 (including NE419 with convergent position in PI)

```{r}
neb_selection.df <- all_convergent_neb.df %>%
  filter(total_conv_events >=3 | conv_summary == "PI:2")
write_csv(neb_selection.df, "Genetic_pairs_analysis_Oct_2020/processed_data/convergence/selection_convergent_genes_neb_df.csv")
```
>>>>>>> Stashed changes
