---
title: 'Generate dataset from the convergence analysis'
author: "Stefano Giulieri"
date: "17/06/2022"
output: 
  html_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd(stringr::str_c(here::here(), "/InToxSa_paper/Genetic_pairs"))
msg <- glue::glue("My directory is {getwd()}")
message(msg)
```


Here we create a dataset with convergence data. The whole gene convergence analysis process is described in `Gene_convergence_analysis.Rmd`.

The gene convergence dataset will be assembled using:

1. The gsea output
2. The neb annotation
3. (optional) the list of mutations and isolates with mutations


```{r}
library(tidyverse)
library(seqinr)
# library(BioNet)
rm(list = ls())
```

# Parse GSEA results

```{r}
file.copy("~/Documents/Transfer_with_server/genes", "../../../VANANZ_phenotypes_local/InToxSa_paper/Genetic_pairs/GSEA/", recursive = T, overwrite = T)

for (f in list.files("~/Documents/Transfer_with_server/genes/", pattern = "replacement", recursive = T, full.names = T)){
  file.copy(f, "raw_data/GSEA/genes/")
}

gene_results <- read_tsv("raw_data/GSEA/genes/replacement.results.gene.txt")

ontology_results <- read_tsv("raw_data/GSEA/genes/replacement.results.ontology.txt")
```

Combine in one dataframe

```{r}
df_gsea <- gene_results %>%
  select(neb_locus_tag = Locus, nsub, kb, enrich) %>%
  left_join(ontology_results %>% select(neb_locus_tag = Ontology, glm.pval)) %>%
  arrange(glm.pval) 
```

# Set significance threshold

```{r}
bonf <- .05/n_distinct(df_gsea$neb_locus_tag)
suggest <- 1/n_distinct(df_gsea$neb_locus_tag)

n_genes_with_sub <- df_gsea %>%
  filter(nsub > 0) %>%
  .$neb_locus_tag %>%
  n_distinct()
bonf <- .05/n_genes_with_sub
suggest <- 1/n_genes_with_sub

# bum.mle <- fitBumModel(ontology_results$glm.pval, plot=TRUE)
# tau <- fdrThreshold(fdr=0.05, fb=bum.mle)
```

# Add neb annotation

Phage will be removed because we perform an `inner_join()`

```{r}
df_neb_curated <- readRDS("../../../SAUREUS-GENERAL/ref_genomes/processed_data/FPR3757/df_neb_curated.Rda")

df_gsea_neb <- df_gsea %>%
  inner_join(df_neb_curated) %>%
  relocate(neb_locus_tag, neb_gene_symbol) 
```

# Add mutations

Here we need to perform a `left_join()`. Why? Because x (`df_gsea`) contains rows that don't exist in y (`df_mutations`), namely genes with no mutations and rows with a `all` compartment

```{r}
df_mutations <- readRDS("processed_data/gene_convergence/df_changes_multi_annot_for_gene_converg.Rda")

df_gsea_neb_with_mutations <- df_gsea_neb %>%
  left_join(df_mutations)
```

# Save processed data

```{r}
# df_gsea_neb %>%
#   saveRDS("processed_data/gene_convergence/df_gsea_neb.Rda")
# df_gsea_neb %>%
#   write_csv("processed_data/gene_convergence/df_gsea_neb.csv")
# 
# df_gsea_neb_with_mutations %>%
#   saveRDS("processed_data/gene_convergence/df_gsea_neb_with_mutations.Rda")
# df_gsea_neb_with_mutations %>%
#   write_csv("processed_data/gene_convergence/df_gsea_neb_with_mutations.csv")
```

# Prepare table 2 

```{r}
# list of genes 
top_genes <- df_gsea_neb %>%
  filter(enrich > 1) %>%
  filter(glm.pval < bonf) %>%
  .$neb_gene_symbol%>%
  unique()

# extract dataframe to prepare the table
df_top_genes <- df_gsea_neb_with_mutations %>%
  filter(neb_gene_symbol %in% top_genes) %>%
  arrange(AA_POS) 
# summary table
top_genes_mutations <- df_top_genes %>%
  group_by(neb_gene_symbol, EFFTYPE_SHORT) %>%
  summarise(mutations = str_c(unique(MUTATION_SHORT), collapse = ", ")) %>%
  pivot_wider(names_from = EFFTYPE_SHORT, values_from = mutations)


table_2_prepare <- df_top_genes %>%
  group_by(neb_gene_symbol, neb_product,  glm.pval) %>%
  summarise(n_mutations = n_distinct(pair_id)) %>%
  left_join(top_genes_mutations) %>%
  ungroup() %>%
  mutate(neb_gene_symbol = fct_relevel(neb_gene_symbol, top_genes)) %>%
  arrange(neb_gene_symbol) 

table_2_prepare %>%
  select(glm.pval)
# %>%
#   docxtools::format_engr() %>%
#   knitr::kable()

dir <-"processed_data/gene_convergence/"

# table_2_prepare %>%
#   write_csv(str_c(dir, "table_2_prepare.csv"))
  
```

# Prepare table 3

```{r}
# list of genes 
top_genes <- df_gsea_neb %>%
  filter(enrich > 1) %>%
  filter(glm.pval > bonf & glm.pval < suggest) %>%
  .$neb_gene_symbol%>%
  unique()

# extract dataframe to prepare the table
df_top_genes <- df_mutations %>%
  filter(neb_gene_symbol %in% top_genes) %>%
  arrange(AA_POS) %>%
  relocate(neb_gene_symbol)
# summary table
top_genes_mutations <- df_top_genes %>%
  group_by(neb_gene_symbol, EFFTYPE_SHORT) %>%
  summarise(mutations = str_c(unique(MUTATION_SHORT), collapse = ", ")) %>%
  pivot_wider(names_from = EFFTYPE_SHORT, values_from = mutations)


table_3_prepare <- df_gsea_neb_with_mutations %>%
  filter(neb_gene_symbol %in% top_genes) %>%
  group_by(neb_gene_symbol, neb_product, glm.pval) %>%
  summarise(n_mutations = n_distinct(pair_id)) %>%
  left_join(top_genes_mutations) %>%
  ungroup() %>%
  mutate(neb_gene_symbol = fct_relevel(neb_gene_symbol, top_genes)) %>%
  arrange(neb_gene_symbol)


# table_3_prepare %>%
#   write_csv(str_c(dir, "table_3_prepare.csv"))
  
```


