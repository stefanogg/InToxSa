---
title: "Generate datasets of within host pairs"
author: "Stefano Giulieri"
date: "30/06/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd(paste0(here::here(), "/8-eLife_revision/Within_host_pairs"))
getwd()
```

Here we get PI uptake and cytoxicity data for within host pairs that were investigated in Giulieri, Genome Med 2018

```{r}
library(tidyverse)
library(patchwork)
rm(list = ls())
```

# List of within-host pairs

```{r}
within_host <- read_csv("../../1-plate_info/strain_metadata.csv") %>%
  filter(included)
```

Add patient IDs used in Giulieri, Genome Medicine 2018

```{r}
patient_id <- read_csv("~/OneDrive - The University of Melbourne/R/VANESSA_ANZCOSS/dataframes/whost_n130_df_new.csv") %>% select(strain_group = studyid, strain_group2 = patient_code_n130) %>%
  distinct()

within_host <- within_host %>%
  inner_join(patient_id)
```


How many have supernatant cytoxicity data?

```{r}
f <- "~/OneDrive - The University of Melbourne/R/VANESSA_ANZCOSS/data/whost_toxicity.csv"
file.copy(f, "raw_data")
cytox_supernat <- read_csv("raw_data/whost_toxicity.csv") %>%
  rename(sample_id = mdu_id, pct_dead_cells_range = range)
```

Get PI uptake parameters

```{r}
PI_data <- readRDS("../../5-Data_processing/processed_data/clinical_strains/PI_parameters/PI_sample_parameters.Rda") %>%
  inner_join(within_host)
unique(PI_data$sample_id)
```

Get PI pair data

```{r}
PI_pairs_within_host <- readRDS("../Genetic_pairs/raw_data/df_cleaned_pair_PI.Rda") %>%
  filter(strain_group_iso1 == strain_group_iso2)

within_host <- within_host %>%
  mutate(PI_pair = sample_id %in% c(PI_pairs_within_host$iso1, PI_pairs_within_host$iso2)) %>%
  group_by(strain_group) %>%
  mutate(PI_pair = sum(PI_pair) > 1)
```


One merged dataframe

```{r}
PI_within_host_all <- within_host %>%
  left_join(PI_data) %>%
  left_join(cytox_supernat) 

PI_within_host <- within_host %>%
  inner_join(PI_data) %>%
  inner_join(cytox_supernat) %>%
  group_by(strain_group) %>%
  filter(n_distinct(sample_id) > 1) %>%
  ungroup()
```

# Statistics

How many isolates

```{r}
PI_within_host_all %>%
  drop_na(AUC_death_mean) %>%
  nrow()
```

How many episodes, how many isolates per episode

```{r}
PI_within_host_summary <- PI_within_host_all %>%
  drop_na(AUC_death_mean) %>%
  count(strain_group)

summary(PI_within_host_summary$n)
```

