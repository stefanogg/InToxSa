---
title: "Compare PI uptake between independent pairs"
author: "Stefano Giulieri"
date: "08/03/2023"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
setwd(str_c("~/Documents/Github/InToxSa", "/8-eLife_revision/Genetic_pairs"))
msg <- glue::glue("My directory is {getwd()}")
message(msg)
```

Here we try a different approach to the genetic pairs analysis. Instead of looking at convergent within pairs with a definite phenotype, we look at phenotypica differences between independent pairs *with* or *without* homoplasic mutations

```{r message=F}
library(tidyverse)
rm(list = ls())
```


# Raw data

Pairs data collected so far

```{r}
pairs_data <- readRDS("processed_data/PI_pairs_data/pairs_description_with_phylo_dataframe.Rda")

mutations <- readRDS("processed_data/variants_combined_annotation/snippy_denovo_annotated.Rda")
```

Each observation is a pair and for each pair we define presence / absence of mutations in certain genes.

First define list of pairs

```{r}
df_pairs <- pairs_data %>%
  filter(dist_denovo <= 200)
```

Now combine with mutations to create a matrix of mutated / non mutated gene

```{r}
df_mutated_genes <- df_pairs %>%
  inner_join(mutations) %>%
  drop_na(neb_mutant_id) %>%
  filter(EFFTYPE_SHORT %in% c("truncating", "non-synonymous")) %>%
  select(pair_id, PI_pair, delta_auc, neb_gene_symbol, EFFTYPE_SHORT) %>%
  distinct() %>%
  mutate(is_mutated = T,
         is_truncated = EFFTYPE_SHORT == "truncating")
```

Now complete missing combinations (this might be complicated)

```{r}
df_mutated_genes_complete <- df_mutated_genes %>%
  select(pair_id, neb_gene_symbol, is_mutated) %>%
  complete(pair_id, neb_gene_symbol, fill = list(is_mutated = F))


df_mutated_genes_complete <- df_mutated_genes %>%
  select(-EFFTYPE_SHORT) %>%
  complete(neb_gene_symbol, nesting(pair_id, PI_pair, delta_auc), explicit = T, fill = list(is_mutated = F, is_truncated = F))
```

Try plot

```{r}
theme_set(theme_bw(base_size = 16))

(genes <- readRDS("../../6-InToxSa_paper/Genetic_pairs/processed_data/gene_convergence/convergence_plots.Rda")[[1]][[1]] %>%
    arrange(cluster_order) %>%
    pull(cdhit_symbol) %>%
  unique())

df_mutated_genes_complete %>%
  filter(neb_gene_symbol %in% genes) %>%
  ggplot(aes(x = is_mutated, y = abs(delta_auc))) +
  geom_boxplot() +
  facet_wrap(~neb_gene_symbol)

df_mutated_genes_complete %>%
  filter(neb_gene_symbol %in% genes) %>%
  ggplot(aes(x = is_truncated, y = abs(delta_auc))) +
  geom_boxplot() +
  facet_wrap(~neb_gene_symbol)
```

# Limit to independent pairs

Generate a database of independent pairs

```{r}
data_list <- list()
nodes <- c()
# i = 1
data_list[[1]] <- df_pairs[1,]
nodes <- unlist(c(df_pairs[1,]$mrca, df_pairs[1,]$path_nodes))
# i > 1
for (i in seq_along(df_pairs$pair_id)){
  if (i == 1) next
  else {
    df <- df_pairs[i,]
    my_nodes <- unlist(c(df_pairs[i,]$mrca, df_pairs[i,]$path_nodes))
    if (length(intersect(my_nodes, nodes)) == 0){
      data_list[[length(data_list) + 1]] <- df
      nodes <- c(nodes, my_nodes)
    } else {
      next
    }
  }
}

df_gp <- bind_rows(data_list)
```


Now combine with mutations to create a matrix of mutated / non mutated gene

```{r}
df_mutated_genes <- df_gp %>%
  inner_join(mutations) %>%
  drop_na(neb_mutant_id) %>%
  filter(EFFTYPE_SHORT %in% c("truncating", "non-synonymous")) %>%
  select(pair_id, PI_pair, delta_auc, neb_gene_symbol, EFFTYPE_SHORT) %>%
  distinct() %>%
  mutate(is_mutated = T,
         is_truncated = EFFTYPE_SHORT == "truncating")
```

Now complete missing combinations (this might be complicated)

```{r}
df_mutated_genes_complete <- df_mutated_genes %>%
  select(pair_id, neb_gene_symbol, is_mutated) %>%
  complete(pair_id, neb_gene_symbol, fill = list(is_mutated = F))


df_mutated_genes_complete <- df_mutated_genes %>%
  select(-EFFTYPE_SHORT) %>%
  complete(neb_gene_symbol, nesting(pair_id, PI_pair, delta_auc), explicit = T, fill = list(is_mutated = F, is_truncated = F))
```

Try plot

```{r}
df_mutated_genes_complete %>%
  filter(neb_gene_symbol %in% genes) %>%
  ggplot(aes(x = is_mutated, y = abs(delta_auc))) +
  geom_boxplot() +
  facet_wrap(~neb_gene_symbol)

df_mutated_genes_complete %>%
  filter(neb_gene_symbol %in% genes) %>%
  ggplot(aes(x = is_truncated, y = abs(delta_auc))) +
  geom_boxplot() +
  facet_wrap(~neb_gene_symbol)
```

Summary dataset

```{r}
df_auc <- df_mutated_genes_complete %>%
  mutate(delta_auc = abs(delta_auc)) %>%
  group_by(neb_gene_symbol, is_mutated) %>%
  summarise(mean_delta = mean(delta_auc))
```

# Write as function

```{r}
generate_gp_replicates <- function(rep, df){
  set.seed(rep)
  df <- df %>%
    ungroup() %>%
    slice_sample(prop = 1)
  data_list <- list()
  nodes <- c()
  # j = 1
  data_list[[1]] <- df[1, ]
  nodes <- unlist(c(df[1, ]$mrca, df[1, ]$path_nodes))
  # j > 1
  for (j in seq_along(df$pair_id)) {
    if (j == 1)
      next
    else {
      my_df <- df[j, ]
      my_nodes <-
        unlist(c(df[j, ]$mrca, df[j, ]$path_nodes))
      if (length(intersect(my_nodes, nodes)) == 0) {
        data_list[[length(data_list) + 1]] <- my_df
        nodes <- c(nodes, my_nodes)
      } else {
        next
      }
    }
  }
  df_gp <- bind_rows(data_list)
  
  
  return(df_gp)
}

df1 <- generate_gp_replicates(1, df_pairs)
df2 <- generate_gp_replicates(2, df_pairs)
setdiff(df1, df2)
```

Now add mutations and summarise auc

```{r}
compare_auc <- function(df_gp, df_mutations){
  df_mutated_genes <- df_gp %>%
  inner_join(df_mutations) %>%
  drop_na(neb_mutant_id) %>%
  filter(EFFTYPE_SHORT %in% c("truncating", "non-synonymous")) %>%
  select(pair_id, PI_pair, delta_auc, neb_gene_symbol, EFFTYPE_SHORT, replicate) %>%
  distinct() %>%
  mutate(is_mutated = T,
         is_truncated = EFFTYPE_SHORT == "truncating")
  
  df_mutated_genes_complete <- df_mutated_genes %>%
  select(pair_id, neb_gene_symbol, is_mutated) %>%
  complete(pair_id, neb_gene_symbol, fill = list(is_mutated = F))


df_mutated_genes_complete <- df_mutated_genes %>%
  select(-EFFTYPE_SHORT) %>%
  complete(neb_gene_symbol, nesting(pair_id, PI_pair, delta_auc, replicate), explicit = T, fill = list(is_mutated = F, is_truncated = F))

df_auc <- df_mutated_genes_complete %>%
  mutate(delta_auc = abs(delta_auc)) %>%
  group_by(neb_gene_symbol, is_mutated, replicate) %>%
  summarise(mean_delta = mean(delta_auc),
            median_delta = median(delta_auc))

return(list(df_auc, df_mutated_genes_complete))
}

```

Now apply (100 replicates)

```{r}
df_gp <- map_df(1:100, generate_gp_replicates, df = df_pairs, .id = "replicate") %>%
  mutate(replicate = as.integer(replicate))

test <- df_gp %>%
  count(pair_id)

auc_list <- compare_auc(df_gp, mutations)
df_auc <- auc_list[[1]]
df_complete <- auc_list[[2]]
```

We expect to have duplicates values, especially among pairs with mutations, eg if a gene is mutated only once.

```{r}
df_unique <- df_complete %>%
  mutate(delta_auc = abs(delta_auc)) %>%
 select(-c(is_truncated, pair_id, PI_pair)) %>%
  group_by(neb_gene_symbol, is_mutated) %>%
  mutate(n_values = n_distinct(delta_auc)) %>%
  group_by(neb_gene_symbol) %>%
  filter(all(n_values >= 3 )) %>%
  distinct(neb_gene_symbol, delta_auc, is_mutated, .keep_all = T) 

df_stats <- df_unique %>%
  select(-replicate) %>%
  group_by(neb_gene_symbol) %>%
  nest() 
```

Stats
https://broom.tidymodels.org/articles/broom_and_dplyr.html 


```{r}
df_lm <- df_stats %>%
  mutate(lm = map(data, function(df) lm(delta_auc ~ is_mutated, data = df)),
         tidied = map(lm, broom::tidy) ) %>%
  unnest(tidied) %>%
  ungroup() %>%
  filter(term == "is_mutatedTRUE") %>%
  arrange(p.value)

df_lm2 <- df_complete %>%
  mutate(delta_auc = abs(delta_auc)) %>%
  group_by(neb_gene_symbol, replicate) %>%
  nest() 

df_lm2 <- df_lm2 %>%
  mutate(lm = map(data, function(df) lm(delta_auc ~ is_mutated, data = df)),
         tidied = map(lm, broom::tidy) ) %>%
  unnest(tidied) %>%
  ungroup() %>%
  filter(term == "is_mutatedTRUE") %>%
  arrange(p.value)

# df_lm <- df_auc %>%
#   group_by(neb_gene_symbol) %>%
#   nest() 
# 
# df_lm <- df_lm %>%
#   mutate(lm = map(data, function(df) lm(mean_delta ~ is_mutated, data = df)),
#          tidied = map(lm, broom::tidy) ) %>%
#   unnest(tidied)
```

# Plots

```{r}
df_auc %>%
  filter(neb_gene_symbol %in% genes[1:20]) %>%
  ggplot(aes(x = is_mutated, y = mean_delta)) +
  geom_boxplot() +
  facet_wrap(~neb_gene_symbol)

df_auc %>%
  filter(neb_gene_symbol %in% genes[1:20]) %>%
  ggplot(aes(x = is_mutated, y = median_delta)) +
  geom_boxplot() +
  facet_wrap(~neb_gene_symbol)

df_auc %>%
  filter(neb_gene_symbol %in% genes[1:20]) %>%
  ggplot(aes(x = is_mutated, y = median_delta)) +
  geom_boxplot() +
  facet_wrap(~neb_gene_symbol, scales = "free")
```

Final figure

```{r}
theme_update( text = element_text(face = "bold"))
genes <- factor(genes, levels = genes)
(p1 <- df_auc %>%
  inner_join(tibble(neb_gene_symbol = genes, gene_level = factor(genes))) %>%
  distinct() %>%
  ggplot(aes(x = fct_rev(gene_level), y = mean_delta, fill = is_mutated)) +
  geom_boxplot(alpha = .5, outlier.shape = NA) +
  scale_fill_manual(values = c("red", "blue"), labels = c("pairs without mutations", "pairs with mutations"), name = "") +
  labs(x = "", y = "Median delta PI uptake") +
  coord_flip() )
```

All replicates

```{r}
df_unique %>%
  inner_join(tibble(neb_gene_symbol = genes, gene_level = factor(genes))) %>%
  ggplot(aes(x = fct_rev(gene_level), y = abs(delta_auc), fill = is_mutated)) +
  geom_boxplot(alpha = .5) +
  scale_fill_manual(values = c("red", "blue"), labels = c("pairs without mutations", "pairs with mutations"), name = "") +
  labs(x = "", y = "absolute delta PI uptake") +
  coord_flip() 
```


Multipanel (only 10 randomly selected replicates)

```{r}
my_sample <- sample(1:100, 10)
df_complete %>%
  filter(replicate %in% my_sample) %>%
  inner_join(tibble(neb_gene_symbol = genes, gene_level = factor(genes))) %>%
  ggplot(aes(x = fct_rev(gene_level), y = abs(delta_auc), fill = is_mutated)) +
  geom_boxplot(alpha = .5) +
  scale_fill_manual(values = c("red", "blue"), labels = c("pairs without mutations", "pairs with mutations"), name = "") +
  facet_wrap(~replicate, nrow = 1) +
  labs(x = "", y = "absolute delta PI uptake") +
  coord_flip() 
```

With stats

```{r}
(p2 <- df_lm %>%
   select(neb_gene_symbol, p.value, estimate) %>%
  inner_join(tibble(neb_gene_symbol = genes, gene_level = factor(genes))) %>%
 ggplot(aes(x = fct_rev(gene_level), y = -log10( p.value),  colour = estimate)) +
  geom_point(size = 5) +
   geom_hline(yintercept = -log10(.05/n_distinct(df_lm$neb_gene_symbol)), linetype = "dashed") +
  scale_colour_viridis_c(name = "beta") +
  coord_flip())

```

Here we plot the output of 100 replicate regressions per gene

```{r}
(p3 <- df_lm2 %>%
   select(neb_gene_symbol, estimate) %>%
  inner_join(tibble(neb_gene_symbol = genes, gene_level = factor(genes))) %>%
 ggplot(aes(x = fct_rev(gene_level), y = estimate, colour = estimate > 0)) +
 geom_point(alpha = .5) +
   stat_summary(
     fun = median,
     fun.min = ~quantile(., .05),
     fun.max = ~quantile(., .95),
     geom = "crossbar",
     colour = "black", width = 0.3
   ) +
   scale_colour_manual(values = c("red", "blue"), na.translate = F, name = "Beta > 0") +
  coord_flip())

(p4 <- df_lm2 %>%
     select(neb_gene_symbol, p.value) %>%
  inner_join(tibble(neb_gene_symbol = genes, gene_level = factor(genes))) %>%
 ggplot(aes(x = fct_rev(gene_level), y = -log10(p.value), colour = p.value < .05/n_distinct(df_lm2$neb_gene_symbol))) +
 geom_point(alpha = .5) +
   stat_summary(
     fun = median,
     fun.min = ~quantile(., .05),
     fun.max = ~quantile(., .95),
     geom = "crossbar",
     colour = "black", width = 0.3
   ) +
   scale_colour_values(values = c("red", "blue"), na.translate = F, name = "Beta > 0") +
  coord_flip())
```

Empirical confidence intervals for genes of interest

```{r}
df_ci95 <- df_lm2 %>%
  left_join(tibble(neb_gene_symbol = genes, gene_level = factor(genes))) %>%
  group_by(neb_gene_symbol) %>%
  summarise(median = median(estimate),
            lower = quantile(estimate, .05, na.rm = T),
            upper = quantile(estimate, .95, na.rm = T),
            frac_above = length(which(estimate > 0)))
```


# Save processed data

```{r}
list(df_gp, df_complete, df_unique, df_lm) %>%
  saveRDS("processed_data/gene_convergence/compare_PI_uptake_between_independent_pairs/comparison_df.Rda")

list(p1,p2,p3,p4) %>%
  saveRDS("processed_data/gene_convergence/compare_PI_uptake_between_independent_pairs/comparison_plots.Rda")
```

