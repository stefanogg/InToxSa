---
title: "PCA_analysis_VANANZ"
author: "R Guerillot"
date: "03/04/2020"
output: html_document
---

# Set/check knitR option and working directory
```{r setup, include=T}
library(tidyverse)
library(here)
library(adegenet)
library(factoextra)
library(corrplot)
library(RColorBrewer)
library(caret)
library(cluster)

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here())
print(paste("My working directory is:" ,here()))
```

# Generate parameter index by correcting  parameters by JE2 for each experiment
```{r}
source("Functions/all_functions.R")
JE2_GC_median_param_long <-  read.csv("Ideas_Grant_2020_analysis/Processed_data/Growth_curves/processed_parameters_GC.csv") %>%
  filter(sample_id == "JE2") %>%
  select_if(grepl("OD", names(.)) | grepl("sample_id", names(.)) | grepl("experiment", names(.))) %>%
  group_by(experiment) %>%
  summarise_if(is.numeric, median) %>%
  ungroup() %>%
  pivot_longer(ends_with("OD")) %>%
  rename(JE2_value = value)

JE2_PI_median_param_long <-  read.csv("Ideas_Grant_2020_analysis/Processed_data/PI_curves/processed_parameters_PI.csv") %>%
  filter(sample_id == "JE2") %>%
  select_if(grepl("death", names(.)) | grepl("sample_id", names(.)) | grepl("experiment", names(.))) %>%
  group_by(experiment) %>%
  summarise_if(is.numeric, median) %>%
  ungroup() %>%
  pivot_longer(ends_with("death")) %>%
  rename(JE2_value = value)

all_GC_param_JE2_corrected <-  read.csv("Ideas_Grant_2020_analysis/Processed_data/Growth_curves/processed_parameters_GC.csv") %>%
  filter(strain_group != "CONTROL") %>%
  select_if(grepl("OD", names(.)) | grepl("sample_id", names(.)) | grepl("experiment", names(.))) %>%
  pivot_longer(ends_with("OD")) %>%
  merge(., JE2_GC_median_param_long, by = c("experiment", "name"), all.x = T, all.y = F) %>%
  filter(!is.na(JE2_value)) %>%
  mutate(value = value/JE2_value) %>%
  group_by(sample_id, name) %>%
  summarise_if(is.numeric, median) %>%
  ungroup() %>%
  select(-JE2_value) %>%
  pivot_wider()

all_PI_param_JE2_corrected <-  read.csv("Ideas_Grant_2020_analysis/Processed_data/PI_curves/processed_parameters_PI.csv") %>%
  filter(strain_group != "CONTROL") %>%
  select_if(grepl("death", names(.)) | grepl("sample_id", names(.)) | grepl("experiment", names(.))) %>%
  pivot_longer(ends_with("death")) %>%
  merge(., JE2_PI_median_param_long, by = c("experiment", "name"), all.x = T, all.y = F) %>%
  filter(!is.na(JE2_value))  %>%
  mutate(value = value/JE2_value) %>%
  group_by(sample_id, name) %>%
  summarise_if(is.numeric, median) %>%
  ungroup() %>%
  select(-JE2_value) %>%
  pivot_wider()
  


```


# merge corrected data
```{r}
# !!! use corrected mortality metadata, the following changes in the sample metadata table have been made:
# 1) all isolates recovered from patient who survived are now labeled "survived" (previously only first isolate)
# 2) only the last isolate from patient who died are labeled "died" (previously on l first) 
sample_meta.df <- read.csv("Ideas_Grant_2020_analysis/Raw_data/strain_metadata_corrected_mortality_with_controls.csv") 



median_sample_parameters_all.df <- merge(all_GC_param_JE2_corrected, all_PI_param_JE2_corrected, by = "sample_id") %>% 
  select(-time_of_min_OD, -time_of_min_death, -end_point_timepoint_OD, -end_point_timepoint_death, -min_OD, -min_death, -doubling_time_OD, -doubling_time_death ) %>% 
  merge(., sample_meta.df, by = "sample_id") %>%
  mutate(ST_simp = fct_lump(ST, n = 5)) %>%
  filter(!is.na(mortality)) 
  

median_param_dat.df <- median_sample_parameters_all.df %>%
  select_if(grepl("OD", names(.)) | grepl("death", names(.)))

```

# Check which plates remain in the dataset
```{r}
plate_meta.df <- read.csv("plate_info/well_info_n843_M1M2_P1P2.csv") %>%
  filter(plate %in% c("1","2","3","4","5","6","P1","P2","M1","M2")) %>%
  select(sample_id, plate) %>%
  merge(median_sample_parameters_all.df, .)

count(plate_meta.df, plate)

```

plate 5, P1 and M1 are lost because JE2 are outliers in these GC plates => fitered out for both PI and GC

# Check each variable individually
```{r}
for (var in  str_extract(colnames(median_sample_parameters_all.df), ".*OD*") %>% na.omit()) {
  t<-ggplot(median_sample_parameters_all.df, aes_string(x = var))+
    geom_density(aes(fill = mortality), alpha = .5)
  print(t)
}

for (var in  str_extract(colnames(median_sample_parameters_all.df), ".*death*") %>% na.omit()) {
  t<-ggplot(median_sample_parameters_all.df, aes_string(x = var))+
    geom_density(aes(fill = mortality), alpha = .5)
  print(t)
}

for (var in  str_extract(colnames(median_sample_parameters_all.df), ".*OD*") %>% na.omit()) {
  t <- ggviolin(data = median_sample_parameters_all.df,
          y = var,
          x = "mortality",
          fill = "mortality") +
  theme_bw() +
  theme(legend.position = "none")+
  stat_compare_means(ref.group ="Survived",
                     method = "wilcox.test",
                     label = "p.signif")
  print(t)
}

for (var in  str_extract(colnames(median_sample_parameters_all.df), ".*death*") %>% na.omit()) {
  t <- ggviolin(data = median_sample_parameters_all.df,
          y = var,
          x = "mortality",
          fill = "mortality") +
  theme_bw() +
  theme(legend.position = "none")+
  stat_compare_means(ref.group ="Survived",
                     method = "wilcox.test",
                     label = "p.signif")
  print(t)
}



```


# Check vriable correlation with correlogram
```{r}
M <-cor(median_param_dat.df, method = "pearson")
corrplot(M, type="upper")

M <-cor(median_param_dat.df, method = "kendall")
corrplot(M, type="upper")

M <-cor(median_param_dat.df, method = "spearman")
corrplot(M, type="upper")
```


# Format parameter df for PCA
```{r}
pca.df <- median_param_dat.df
row.names(pca.df) <- median_sample_parameters_all.df$sample_id

pca1 <- dudi.pca(df = pca.df, scannf = F, nf = 5, scale = T)
```

## Plot % variance explained per axes
```{r}
fviz_screeplot(pca1, addlabels = T)
```


## Plot individual and variable loading with group
```{r}
# mortality
fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind =  median_sample_parameters_all.df$mortality,
             col.circle = median_sample_parameters_all.df$mortality ,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(2,3),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind =  median_sample_parameters_all.df$mortality,
             col.circle = median_sample_parameters_all.df$mortality ,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )
#ST
fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind =  median_sample_parameters_all.df$ST_simp,
             col.circle = median_sample_parameters_all.df$ST_simp ,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(2,3),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind =  median_sample_parameters_all.df$ST_simp,
             col.circle = median_sample_parameters_all.df$ST_simp ,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

```

# Contributions of variables to PC1
```{r}
fviz_contrib(pca1, choice = "var", axes = 1)
```

# Contributions of variables to PC2
```{r}
fviz_contrib(pca1, choice = "var", axes = 2)
```

# Contribution of variables to PC1 to 4
```{r}
fviz_contrib(pca1, choice = "var", axes = 1:4)
```

# Rerun PCA with variable with max contrib.
```{r}
pca.df <- median_param_dat.df %>%
  select(max_death, end_point_OD, AUC_death, end_point_death, max_OD, AUC_OD, max_rate_death) %>%
#  select(AUC_death, AUC_OD, max_OD, max_rate_death, max_rate_OD, doubling_time_OD) %>%
  filter(!is.na(median_sample_parameters_all.df$mortality))
#row.names(pca.df) <- median_sample_parameters_all.df$sample_id

pca1 <- dudi.pca(df = pca.df, scannf = F, nf = 5, scale = T, center = T)
```

## Plot % variance explained per axes
```{r}
fviz_screeplot(pca1, addlabels = T)
```


## Plot individual and variable loading with group
```{r}
# mortality
fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .75,
             col.ind =  median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$mortality,
             col.circle = median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$mortality,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(2,3),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .75,
             col.ind =  median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$mortality,
             col.circle = median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$mortality ,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .75,
             col.ind =  median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$ST_simp,
             col.circle = median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$ST_simp,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(2,3),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .75,
             col.ind =  median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$ST_simp,
             col.circle = median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$ST_simp ,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

```




# Compute Discriminant Analysis of Principal Components (DAPC)
```{r}
pca.df <- median_param_dat.df %>%
   filter(!is.na(median_sample_parameters_all.df$mortality))
  
row.names(pca.df) <- median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$sample_id

# All vs All

dapc1 <- adegenet::dapc(x = pca.df,
                        grp = median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$mortality == "Died",
                        n.pca = 6, 
                        n.da = 2, 
                        scale = T,
                        center = T)
summary(dapc1)

scatter.dapc(dapc1)
dapc1$var.contr
loadingplot(dapc1$var.contr)

dapc0 <-data.frame(comparison = "All vs ALL", 
                   var = row.names(dapc1$var.contr), 
                   contrib = as.character(dapc1$var.contr), 
                   row.names = NULL)


```

# reconpute PCA with only best mortality discriminating variable

```{r}
pca.df <- pca.df %>%
  select(time_of_max_OD, max_rate_OD, time_of_max_rate_death )

pca1 <- dudi.pca(df = pca.df, scannf = F, nf = 5, scale = T, center = T)
```

## Plot % variance explained per axes
```{r}
fviz_screeplot(pca1, addlabels = T)
```


## Plot individual and variable loading with group
```{r}
# mortality
fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind =  median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$mortality,
             col.circle = median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$mortality,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(1,3),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind =  median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$mortality,
             col.circle = median_sample_parameters_all.df %>% filter(!is.na(mortality)) %>% .$mortality,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )




```



# Try random forest classifier
```{r}
library(randomForest)


# add sample_id number (ID) to median_sample_parameters_all.df
median_sample_parameters_all.df <- median_sample_parameters_all.df %>%
  mutate(ID = row.names(.))

rf.df <- median_sample_parameters_all.df %>%
  select_if(grepl("OD", names(.)) | grepl("death", names(.))) %>%
  mutate(mortality = median_sample_parameters_all.df$mortality) %>%
  mutate(ID = median_sample_parameters_all.df$ID) %>%
  mutate(ST_simp =  median_sample_parameters_all.df$ST_simp)

# can filter or sample here
rf.df <- rf.df %>%
  filter(!is.na(mortality))

rownames(rf.df) <- rf.df$ID


set.seed(100)
# train <- sample(nrow(EM.rf.df), 0.7*nrow(EM.rf.df), replace = FALSE)
# TrainSet <- EM.rf.df[train,]
# ValidSet <- EM.rf.df[-train,]

pred_rf.df <- rf.df %>% select(-mortality, -ID, -ST_simp)
resp_rf.vec <- rf.df$mortality

model1 <- randomForest(x = pred_rf.df, y= resp_rf.vec, data = EM.rf.df, importance = TRUE, ntree = 300)

model1

varImpPlot(model1)



# Predicting on Validation set
predValid <- predict(model1, rf.df, type = "class")
predValid <- as.data.frame(predValid) %>% 
  mutate(ID = rownames(.)) %>%
  rename(Prediction = predValid) %>%
  merge(., rf.df %>% select(ID, mortality),  by = "ID")%>%
  droplevels() %>%
  mutate(Accurate = ifelse(Prediction == mortality, T, F))

# Predict class proba
predValid_prob <- predict(model1, rf.df, type="prob")%>%
  as.data.frame(.) %>%
  mutate(ID = rownames(.)) %>%
  merge(., predValid)

# Checking classification accuracy
mean(predValid$Accurate)                    
table(predValid$Prediction, predValid$mortality)
table(predValid$mortality, predValid$Accurate)

# Keep n best predicted for each strain
best_pred.df <- predValid_prob %>%
  filter(Accurate == T) %>%
  mutate(Accurate_proba = pmax(Died, Survived)) %>%
  group_by(mortality) %>%
  #filter(Accurate_proba > 0.9)
  top_frac(.5, Accurate_proba)
  
count(best_pred.df, mortality)  
```

## Re-compute PCA with best accurately classified 
```{r}
pca_meta.df3 <-  rf.df %>%
  filter(ID %in% best_pred.df$ID) 

pca.df3 <- pca_meta.df3 %>%
  select(-ID, -mortality, -ST_simp)

pca3 <- dudi.pca(df = pca.df3, scannf = F, nf = 5, scale = T)
```

## Plot PCA
```{r}
fviz_screeplot(pca3, addlabels = T)

fviz_pca_biplot(pca3,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind = pca_meta.df3$mortality,
             col.circle = pca_meta.df3$mortality,
             title = paste("PCA - Top 20% of accurately classified strains (Strain prototypes)" ),
             repel = T,
             pointshape = 16)
 
fviz_pca_biplot(pca3,
             #select.ind = list(contrib = 10),
             axes = c(2,3),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind = pca_meta.df3$mortality,
             col.circle = pca_meta.df3$mortality,
             title = paste("PCA - Top 20% of accurately classified strains (Strain prototypes)" ),
             repel = T,
             pointshape = 16)

fviz_pca_biplot(pca3,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .8,
             addEllipses = T,
             ellipse.level = .95,
             col.ind = pca_meta.df3$ST_simp,
             col.circle = pca_meta.df3$ST_simp,
             title = paste("PCA - Top 20% of accurately classified strains (Strain prototypes)" ),
             repel = T,
             pointshape = 16)
 
fviz_pca_biplot(pca3,
             #select.ind = list(contrib = 10),
             axes = c(2,3),
             geom = c("point"),
             alpha.ind = .95,
             addEllipses = T,
             #ellipse.level = .99,
             col.ind = pca_meta.df3$ST_simp,
             col.circle = pca_meta.df3$ST_simp,
             title = paste("PCA - Top 20% of accurately classified strains (Strain prototypes)" ),
             repel = T,
             pointshape = 16)

```




# Try random forest unsupervised
```{r}
# library(randomForest)


# add sample_id number (ID) to median_sample_parameters_all.df
median_sample_parameters_all.df <- median_sample_parameters_all.df %>%
  mutate(ID = row.names(.))

rf.df <- median_sample_parameters_all.df %>%
  select_if(grepl("OD", names(.)) | grepl("death", names(.))) %>%
  mutate(mortality = median_sample_parameters_all.df$mortality) %>%
  mutate(ID = median_sample_parameters_all.df$ID) %>%
  mutate(ST_simp =  median_sample_parameters_all.df$ST_simp) %>%
  mutate(sample_id = median_sample_parameters_all.df$sample_id)

# can filter or sample here
rf.df <- rf.df %>%
  filter(!is.na(mortality))

rownames(rf.df) <- rf.df$ID


set.seed(100)
# train <- sample(nrow(EM.rf.df), 0.7*nrow(EM.rf.df), replace = FALSE)
# TrainSet <- EM.rf.df[train,]
# ValidSet <- EM.rf.df[-train,]

pred_rf.df <- rf.df %>% select(-mortality, -ID, -ST_simp, -sample_id)
resp_rf.vec <- rf.df$mortality

model1 <- randomForest(x = pred_rf.df, data = EM.rf.df, importance = TRUE, ntree = 100)

model1

varImpPlot(model1)

prox <- model1$proximity
pam.rf <- pam(prox, 4)
pred <- cbind(pam.rf$clustering, as.character(rf.df$sample_id), as.character(rf.df$ST_simp), as.character(rf.df$mortality))
table(pred[,1], pred[,2])
table(pred[,1], pred[,3])
table(pred[,1], pred[,4])


cluster.df <-cbind(pam.rf$clustering, as.character(rf.df$sample_id)) %>% as.data.frame()
colnames(cluster.df) <- c("cluster", "sample_id")
  
pca_meta.df4 <-  rf.df %>%
  merge(.,  cluster.df ,  by = "sample_id") 

pca.df4 <- pca_meta.df4 %>%
  select(-sample_id, -cluster, -ST_simp, -mortality, -ID)

pca4 <- dudi.pca(df = pca.df4, scannf = F, nf = 5, scale = T)



fviz_screeplot(pca4, addlabels = T)

fviz_pca_biplot(pca4,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind = pca_meta.df4$cluster,
             title = paste("" ),
             repel = T,
             pointshape = 16)

fviz_pca_biplot(pca4,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .95,
             col.ind = pca_meta.df4$mortality,
             title = paste("" ),
             repel = T,
             pointshape = 16)



```
