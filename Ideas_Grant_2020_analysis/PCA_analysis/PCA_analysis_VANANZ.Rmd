---
title: "PCA_analysis_VANANZ"
author: "R Guerillot"
date: "03/03/2020"
output: html_document
---

# Set/check knitR option and working directory
```{r setup, include=T}
library(tidyverse)
library(here)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here())
print(paste("My working directory is:" ,here()))
```

# import/normalise/fit PI data
```{r}
source("Functions/all_functions.R")
all_PI.df <- read.csv("Data_parsing/dataframes/concatenated_datasets/PI_kinetics_data.csv") %>%
  JE2_POMS_standardisation(.) %>%
  fit_smooth_spline(.)

```

# identify outliers
```{r}
outliers.df <- all_PI.df %>% summarise_outlier(.)

# Identify all well with outliers >10% outliers within each experiment or combined with all experiment and using any outlier detection methods (sd, mad, tukey) 
outliers_list <- outliers.df %>%
  filter_at(vars(starts_with("proportion_outlier_exp")), any_vars( . > .2)) %>%
  .$well_id

length(outliers_list)
```

# Re-import filter outliers and re-normalise/fit PI data
```{r}
all_PI_filtered.df <- read.csv("Data_parsing/dataframes/concatenated_datasets/PI_kinetics_data.csv") %>%
  mutate(well_id = as.character(well_id)) %>%
  filter(!(well_id %in% outliers_list)) %>%
  JE2_POMS_standardisation(.) %>%
  fit_smooth_spline(.)
```


# extract PI kinetic parameters and calculate sample means
```{r}
all_PI_parameters.df <- get_parameters(all_PI_filtered.df) %>% 
  group_by(sample_id) %>%
  summarise(AUC = mean(AUC),
         time_of_max_death = mean(time_of_max_death),
         max_death = mean(max_death),
         time_of_min_death = mean(time_of_min_death),
         min_death = mean(min_death),
         time_of_max_death_rate = mean(time_of_max_death_rate),
         max_death_rate = mean(max_death_rate),
         time_of_min_death_rate = mean(time_of_min_death_rate),
         min_death_rate = mean(min_death_rate)) %>%
    ungroup() %>%
  filter(!(sample_id %in% c("Complete lysis", "Non infected")))
```

# merge with strain metadata
```{r}
strain_meta.df <- read.csv("plate_info/strain_metadata.csv")

all_PI_parameters.df <- merge(all_PI_parameters.df,
                               strain_meta.df,
                               by = "sample_id") %>%
  mutate(ST_simp = fct_lump(ST, n = 5))

```


# Format parameter df for PCA
```{r}
library(adegenet)
library(factoextra)

pca.df <- all_PI_parameters.df
row.names(pca.df) <- all_PI_parameters.df$sample_id

pca.df <-  pca.df %>% 
  select(AUC,
         time_of_max_death,
         max_death,
         time_of_min_death,
         min_death,
         time_of_max_death_rate,
         max_death_rate,
         time_of_min_death_rate,
         min_death_rate)


pca1 <- dudi.pca(df = pca.df, scannf = F, nf = 5, scale = T)
```

## Plot % variance explained per axes
```{r}
fviz_screeplot(pca1, addlabels = T)
```
--> Keep only dimensions 1 + 2 as they represent > 80% of variance

## Plot individual and variable loading with group
```{r}

fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .75,
             col.ind =  all_PI_parameters.df$ST_simp,
             col.circle = all_PI_parameters.df$ST_simp,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

fviz_pca_biplot(pca1,
             #select.ind = list(contrib = 10),
             axes = c(1,2),
             geom = c("point"),
             alpha.ind = .5,
             addEllipses = T,
             ellipse.level = .75,
             col.ind = all_PI_parameters.df$mortality,
             col.circle = all_PI_parameters.df$mortality,
             title = paste("PCA with variable loading" ),
             #repel = T,
             pointshape = 16,
             )

```

# Contributions of variables to PC1
```{r}
fviz_contrib(pca1, choice = "var", axes = 1)
```

# Contributions of variables to PC2
```{r}
fviz_contrib(pca1, choice = "var", axes = 2)
```

# Contribution of variables to PC1 and 2
```{r}
fviz_contrib(pca1, choice = "var", axes = 1:2)
```
