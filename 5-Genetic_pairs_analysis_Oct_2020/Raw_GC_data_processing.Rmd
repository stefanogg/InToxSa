---
title: "Raw data processing"
author: "R Guerillot"
date: "24/02/2020"
output: html_document
---

# Set/check knitR option and working directory
```{r setup, include=T}
library(tidyverse)
library(here)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here())
print(paste("My working directory is:" ,here()))
```

# Source all function
```{r}
source("Functions/all_functions.R")
```

# Import all VANANZ GC and growth curve data (plate 1-6 + P1-2, M1- GP1-7)

```{r}
raw_GC.df <- list.files(path="Data_parsing/parsed_experiments/", pattern="growth", full.names=TRUE, recursive=T) %>% 
  map_df(~read_csv(., col_types = cols(well_row = col_factor(),
                                      well_col = col_factor(),
                                      OD = col_number(),
                                      well = col_factor(),
                                      experiment = col_factor(),
                                      plate = col_factor(),
                                      well_id = col_factor(),
                                      timepoint = col_integer(),
                                      sample_id = col_factor(),
                                      replicate = col_factor(),
                                      strain_group = col_factor()))) %>%
  filter(!is.na(OD)) %>%
  filter(!is.na(sample_id)) %>%
  mutate(experiment_id = str_c(experiment, "_", plate))   # Create a experiment variable that is unique
                                                          # -> two plate were done the same day => same exp.)
  raw_GC.df$sample_id %>% unique()
```

# Count plates
```{r}
print(paste("Total number of GC plates:", 
            raw_GC.df %>% select(experiment_id) %>% distinct() %>% nrow()))

nb_replicate_plate.df <- raw_GC.df %>% select(experiment, plate) %>% distinct() %>% count(plate,name = "number of plate replicate") %>% print()
```

we have at least one plate replicate for each plate

# Check blank normalisation across dataset
```{r}
raw_GC_t0.df <- raw_GC.df %>% 
  cut_exp_duration() %>%
  select(OD, well, timepoint, well_id, experiment_id, OD_blank_normalised) %>%
  filter(timepoint == 0) %>%
  distinct()

raw_GC_tend.df <- raw_GC.df %>% 
  cut_exp_duration() %>%
  select(OD, well, timepoint, well_id, experiment_id, OD_blank_normalised) %>%
  filter(timepoint == max(timepoint)) %>%
  distinct()

ggplot(raw_GC_t0.df, aes(x = OD, fill= OD_blank_normalised)) +
  geom_histogram(bins = 1000)

ggplot(raw_GC_tend.df, aes(x = OD, fill= OD_blank_normalised)) +
  geom_histogram(bins = 1000)
```

# Re-blank all dataset using mean of "Non infected" and "Blank" wells at T0
```{r}
raw_GC_blank.df <- raw_GC.df %>%
  filter(sample_id %in% c("Non infected")) %>% #, "Complete lysis", "Blank")) %>%
  filter(timepoint == 0) %>%
  group_by(experiment_id) %>%
  summarise(mean_blank_OD = mean(OD), sd_blank_OD = sd(OD), nb_blank_OD = n(), OD_blank_normalised = first(OD_blank_normalised)) %>%
  ungroup()


raw_GC.df <- raw_GC_blank.df %>%
  select(experiment_id, mean_blank_OD) %>%
  merge(raw_GC.df, ., by = "experiment_id", all.x = T) %>%
  mutate(OD = OD - mean_blank_OD) %>%
  mutate(OD_blank_normalised = T) 

```

# Re-check blank normalisation across dataset
```{r}
raw_GC_t0.df <- raw_GC.df %>% 
  cut_exp_duration() %>%
  select(OD, well, timepoint, well_id, experiment_id, OD_blank_normalised) %>%
  filter(timepoint == 0) %>%
  distinct()

raw_GC_tend.df <- raw_GC.df %>% 
  cut_exp_duration() %>%
  select(OD, well, timepoint, well_id, experiment_id, OD_blank_normalised) %>%
  filter(timepoint == max(timepoint)) %>%
  distinct()

ggplot(raw_GC_t0.df, aes(x = OD, fill= OD_blank_normalised)) +
  geom_histogram(bins = 1000) 

ggplot(raw_GC_t0.df, aes(x = OD, fill= OD_blank_normalised)) +
  geom_histogram(bins = 1000) +
  xlim(-.25,0.25)

ggplot(raw_GC_tend.df, aes(x = OD, fill= OD_blank_normalised)) +
  geom_histogram(bins = 1000)
```

# Remove wells all wells with |OD_t0| > 0.1 
```{r}
well_id_not_starting_at_OD0 <- raw_GC_t0.df %>%
  filter(abs(OD) > .1) %>%
  #count(experiment_id)
  .$well_id

raw_GC.df <- raw_GC.df %>%
  filter(!well_id %in% well_id_not_starting_at_OD0)
```

# Check timepoints interval
```{r}
for (exp in raw_GC.df$experiment_id %>% unique()) {
  print(paste(exp,
               raw_GC.df %>%
                 filter(experiment_id == exp) %>%
                 .$timepoint %>%
                 unique() %>%
                 sort() %>%
                 .[[2]]
  )
  )
  
}
```

Different measure interval (time between timepoint) cause variability when extracting curves parameter (e.g. AUC)
# Remove experiment with measuring interval 15 min not 10 min
exp190831_2
exp190905_2
exp190909_2
```{r}
raw_GC.df <- raw_GC.df %>%
  filter(!experiment_id %in% c("exp190831_2", "exp190905_2", "exp190909_2"))

```

# Remove timepoint not divisible by 10 min (e.g. in exp191107_2 with measure every 5 min)
```{r}
raw_GC.df <- raw_GC.df %>%
  filter(divisible(timepoint, 10))
```

# Process GC kinetics data
## Check JE2 reference outlier in each plate

Use stringent criteria to detect JE2 outlier curves
 
Timepoint is outlier if:
  1. |x| > 1.5 x IQR (Tukey's fences method = box plot outlier detection method)
  2. sd > 0.2 (Only timepoints with important variation are considered; sd > 20% of JE2 max)
Curve is outlier if: 
  1. > 5% of timepoints are outliers (outlier_tukey_proportion = 0.05)

Notes: 
  - 3 x sd and 3 x mad methods don't identify more oulier curves as 0.05 proportion threshold; tukey is the most stringent method and therefore the only method used here 
  - sd > 0.2 has been empirically set to avoid flagging outliers with very little variations. Could be improved by defining the sample_id~timepoints wise sd across all dataset
  
```{r}
raw_GC_check <- raw_GC.df %>% rename(f_signal = OD) %>%
  check_reference(reference = "JE2",
                  outlier_tukey_proportion = 0.05, # 1.5 x IQR used
                  outlier_sd_proportion = 1,       # 3 x sd not used
                  outlier_mad_proportion = 1,      # no 3 x mad not used 
                  k_tukey = 1.5,
                  min_sd = 0.2,
                  filter = F,
                  plot = T)
```

### Plot JE2 non outliers and oultiers only
```{r}
raw_GC_check %>% 
  filter(outlier_curve == F) %>%
  plot_cell_death(fitted = T, all_replicates = T) 

raw_GC_check %>% 
  filter(outlier_curve == T) %>%
  plot_cell_death(fitted = T, all_replicates = T)
```

### Count number of JE2 outliers per experiment
```{r}
JE2_outliers_exp_count <- raw_GC_check %>% 
  filter(sample_id == "JE2") %>% 
  select(experiment_id, well_id, outlier_curve) %>% 
  distinct(.) %>% 
  group_by(experiment_id) %>% 
  mutate(total_JE2 = n()) %>% 
  ungroup() %>%
  group_by(experiment_id, outlier_curve) %>%
  mutate(number_curve = n()) %>% 
  ungroup() %>%
  select(-well_id) %>%
  distinct() %>%
  filter(outlier_curve == T) %>%
  mutate(remaining_non_JE2_outliers = total_JE2 - number_curve) %>% 
  select(experiment_id, outlier_curve, number_curve, total_JE2, remaining_non_JE2_outliers) %>%
  print()
```

### Identifiy all well_id corresponding to JE2 ouliers from dataset
```{r}
JE2_outliers_well <- raw_GC_check %>% 
  filter(outlier_curve == T) %>%
  .$well_id %>%
  unique() %>%
  print()
```

### Identify all experiment_id with < 2 JE2 non outlier 
```{r}
JE2_outliers_exp <- JE2_outliers_exp_count %>% 
  filter(remaining_non_JE2_outliers < 2) %>%
  print() %>%
  .$experiment_id 
```

### Check how many plate with < 3 JE3 non-oulier 
```{r}
JE2_outliers_exp_count %>% 
  filter(remaining_non_JE2_outliers < 3) 
```

## Clean raw GC data: 
1. remove JE2 well outliers
2. remove experiments with < 2 JE2
3. standardise (with max time cutting)
4. fit curves
5. indentify and remove outliers (default parameter with tukey + mad + sd proportion > 0.1 (>10% outlier timepoints))
6. calculate derivatives

```{r}
clean_GC_with_outliers.df <- raw_GC.df %>%
  mutate(f_signal = OD) %>%
  filter(!well_id %in% JE2_outliers_well) %>%
  filter(!experiment_id %in% JE2_outliers_exp) %>%
  standardise_curves(cut = T) %>%
  fit_curves(use_standardised = T) %>%
  flag_outlier_curves(use_standardised = T, 
                      min_sd = 0.2,
                      k_sd = 3, 
                      k_mad = 3,
                      k_tukey = 1.5, 
                      outlier_tukey_proportion = 0.1, 
                      outlier_sd_proportion = 0.1, 
                      outlier_mad_proportion = 0.1,
                      filter = F) %>%
  get_derivatives(use_fitted = T) 

clean_GC.df <- clean_GC_with_outliers.df %>%
  filter(outlier_curve == F)

```


### Count clean plates remaining
```{r}
print(paste("Total number of validated GC plates:", 
            clean_GC.df %>% select(experiment_id) %>% distinct() %>% nrow()))

clean_GC_plate_count.df <- clean_GC.df %>% select(experiment, plate) %>% distinct() %>% count(plate,name = "number of plate replicate") %>% print()    
```

### Count proportion of outlier wells per plate
```{r}
ratio_outlier.df <- clean_GC_with_outliers.df %>%
  select(well_id, experiment_id, outlier_curve) %>%
  distinct() %>%
  mutate(outlier_curve = factor(outlier_curve, levels = c(T,F))) %>%
  complete(outlier_curve) %>%
  count(experiment_id, outlier_curve, .drop = F) %>%
  group_by(experiment_id) %>%
  summarise(outlier = paste(outlier_curve, collapse = "/"), ratio_outlier = paste(n, collapse = "/")) %>%
  ungroup() %>%
  separate(col = ratio_outlier, sep = "/", into = c("outlier", "non_outlier")) %>%
  mutate(proportion_outlier = as.numeric(outlier)/as.numeric(non_outlier)) %>%
  arrange(-proportion_outlier) %>%
  print()

```

### Identify excluded isolate sample (outliers)
```{r}
excluded_sample <- setdiff(
raw_GC.df %>% .$sample_id%>% unique(),
clean_GC.df %>% .$sample_id%>% unique()
)

raw_GC.df %>% filter(sample_id %in% excluded_sample) %>%
  select(experiment_id, sample_id) %>%
  distinct() 
```

### Asign experiment replicate number
```{r}
clean_GC.df <- clean_GC.df %>%
  select(plate, experiment_id) %>%
  distinct() %>%
  mutate(number = 1) %>%
  group_by(plate) %>%
  mutate(plate_replicate = as.factor(cumsum(number))) %>%
  ungroup() %>%
  select(experiment_id, plate_replicate) %>%
  merge(clean_GC.df, ., "experiment_id") 
```

### Set sample_id level to get controls first when plotting
```{r}
clean_GC.df <- clean_GC.df %>%
  mutate(sample_id = factor(sample_id, levels = c("JE2", "NE1354", "TOX-4", "NEB agrA", "Non infected", "Complete lysis", sort(unique(grep("BPH", as.character(clean_GC.df$sample_id), value = T))), "Blank")))

```

## Extract GC curves parameters
```{r}
clean_parameters_GC.df <- clean_GC.df %>%
  get_parameters() %>%
  set_names( . %>% str_replace_all("death", "growth"))
  
```

## Calculate sample parameters mean, median, sd, mad, IQR
```{r}
clean_sample_parameters_GC.df <- clean_parameters_GC.df %>%
  group_by(sample_id) %>%
  select(sample_id, ends_with("_growth")) %>%
  summarise_if(is.numeric, funs(mean, sd, median, mad, IQR)) %>%
  merge(., clean_parameters_GC.df %>% select(sample_id, -ends_with("_growth")) %>% distinct(), by = "sample_id") 
```



# Save data
## Create file structure
```{r}
dir.create(path = "Genetic_pairs_analysis_Oct_2020/processed_data", showWarnings = F)
dir.create(path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/", showWarnings = F)
dir.create(path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots", showWarnings = F)
dir.create(path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots/experiment", showWarnings = F)
dir.create(path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots/plate_replicates", showWarnings = F)
dir.create(path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/", showWarnings = F)
dir.create(path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/kinetics", showWarnings = F)
dir.create(path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/parameters", showWarnings = F)
```

## Save processed GC data
```{r}
write.csv(x = clean_GC.df, file ="Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/kinetics/GC_kinetics.csv", row.names = F)

saveRDS(clean_GC.df, file="Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/kinetics/GC_kinetics.Rda", compress = "gzip")

```

## Save GC curves parameters
```{r}
write.csv(x = clean_parameters_GC.df, file ="Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/parameters/GC_parameters.csv", row.names = F)
saveRDS(clean_parameters_GC.df, file="Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/parameters/GC_parameters.Rda")          

write.csv(x = clean_sample_parameters_GC.df, file ="Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/parameters/GC_sample_parameters.csv", row.names = F)
saveRDS(clean_sample_parameters_GC.df, file="Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/parameters/GC_sample_parameters.Rda")     
```


## Save plots for all experiments
```{r}

for (exp in unique(clean_GC.df$experiment_id)){
  GC.df <- clean_GC.df %>% filter(sample_id != "Complete lysis")
  p <- plot_cell_death(GC.df %>% filter(experiment_id == exp),
                       fitted = T,
                       #combine_experiments = c("all"),
                       all_replicates = T,
                       return_plots = T)
  p <- p[[1]] + ylim(min(GC.df$f_signal.fitted), max(GC.df$f_signal.fitted))
  ggsave(filename = exp,
         plot = p,
         device = "jpeg",
         path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots/experiment/",
        width = 29.7, height = 21, units = "cm")
  p
}
```

## Save imported genetic pairs metadata
```{r}
gen_pairs_all.df <- read_csv("Ideas_Grant_2020_analysis/Genetic_pairs_analysis_completed/Raw_data/genetic_pairs_pheno_changes_mortality_persist_switches.csv") %>%
  mutate(pair_id = paste0(pmin(iso1,iso2),"-",pmax(iso1,iso2))) %>%
  select(pair_id, everything()) %>%
  arrange(iso2_mortality) %>%
  select(-ends_with(match = c("_death", "_OD")))

gen_pairs.df <- gen_pairs_all.df %>%
  distinct(pair_id, .keep_all = T)

dir.create(path = "Genetic_pairs_analysis_Oct_2020/metadata")

write.csv(x = gen_pairs_all.df, file = "Genetic_pairs_analysis_Oct_2020/metadata/genetic_pairs_id_metadata.csv", row.names = F)
saveRDS(gen_pairs_all.df, file = "Genetic_pairs_analysis_Oct_2020/metadata/genetic_pairs_id_metadata.Rda")

write.csv(x = gen_pairs.df %>% distinct(pair_id, .keep_all = T), file = "Genetic_pairs_analysis_Oct_2020/metadata/distinct_genetic_pairs_id_metadata.csv", row.names = F)
saveRDS(gen_pairs.df %>% distinct(pair_id, .keep_all = T), file = "Genetic_pairs_analysis_Oct_2020/metadata/distinct_genetic_pairs_id_metadata.Rda")
```

# QC GC data

## Re-check JE2 standardized curves after removing JE2 outliers
```{r}
clean_GC.df %>%
  filter(sample_id == "JE2") %>%
  plot_cell_death(fitted = T, 
                  return_plots = F,
                  all_replicates = T, 
                  combine_experiments = c("experiment"), 
                  ylim = c(min(.$f_signal.fitted), max(.$f_signal.fitted))) 

clean_GC.df %>%
  filter(sample_id == "JE2") %>%
  plot_cell_death(fitted = T, 
                  return_plots = F,
                  all_replicates = T, 
                  combine_experiments = c("plate"), 
                  ylim = c(min(.$f_signal.fitted), max(.$f_signal.fitted))) 

clean_GC.df %>%
  filter(sample_id == "JE2") %>%
  plot_cell_death(fitted = T, 
                  return_plots = T,
                  all_replicates = T, 
                  combine_experiments = c("all"), 
                  ylim = c(min(.$f_signal.fitted), max(.$f_signal.fitted))) %>%
  .[[1]] +
  facet_wrap(~experiment_id)


```


 
 

## Check growth variation across plate's replicates
```{r fig.height=6, fig.width=6}
df <- clean_parameters_GC.df %>% 
         group_by(plate) %>%
         filter(max(as.integer(plate_replicate)) != 1)

# AUC
for (pl in unique(df$plate)){ 
  p <- ggplot(df %>% filter(plate == pl), aes(x = sample_id, y = AUC_growth, colour = experiment)) +
    geom_boxplot() +
    coord_flip() +
    ggtitle(paste("Plate", pl, "replicates")) +
    ylim(min(df$AUC_growth), max(df$AUC_growth)) 
  print(p)
  ggsave(filename = paste0(pl, "_AUC"), 
       plot = p, 
       device = "jpeg", 
       path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots/plate_replicates")
}

# growth rate
for (pl in unique(df$plate)){ 
  p <- ggplot(df %>% filter(plate == pl), aes(x = sample_id, y = max_rate_growth, colour = experiment)) +
    geom_boxplot() +
    coord_flip() +
    ggtitle(paste("Plate", pl, "replicates")) +
    ylim(min(df$max_rate_growth), max(df$max_rate_growth)) 
  print(p)
  ggsave(filename = paste0(pl, "_max_rate"), 
       plot = p, 
       device = "jpeg", 
       path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots/plate_replicates")
}

# growth rate
for (pl in unique(df$plate)){ 
  p <- ggplot(df %>% filter(plate == pl), aes(x = sample_id, y = max_growth, colour = experiment)) +
    geom_boxplot() +
    coord_flip() +
    ggtitle(paste("Plate", pl, "replicates")) +
    ylim(min(df$max_growth), max(df$max_growth)) 
  print(p)
  ggsave(filename = paste0(pl, "_max"), 
       plot = p, 
       device = "jpeg", 
       path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots/plate_replicates")
}

# endpoint OD
for (pl in unique(df$plate)){ 
  p <- ggplot(df %>% filter(plate == pl), aes(x = sample_id, y = end_point_growth, colour = experiment)) +
    geom_boxplot() +
    coord_flip() +
    ggtitle(paste("Plate", pl, "replicates")) +
    ylim(min(df$end_point_growth), max(df$end_point_growth)) 
  print(p)
  ggsave(filename = paste0(pl, "_endpoint"), 
       plot = p, 
       device = "jpeg", 
       path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots/plate_replicates")
}
```


## Plot GC distribution
```{r}
ggplot(clean_sample_parameters_GC.df %>%
         filter(grepl("BPH", sample_id)) , aes(x = AUC_growth_mean)) +
  geom_histogram(binwidth = 2)+
  geom_density(aes(y=2 * ..count..))
```


## Select GC kinetics and parameter corresponding to paired isolates
```{r}
paired_strains <- unique(c(gen_pairs.df$iso1, gen_pairs.df$iso2))

pairs_clean_GC.df <- clean_GC.df %>%
  filter(sample_id %in% paired_strains)
```

## Check genetic pairs lacking in the dataset and number of replicates per strain
```{r}
length(paired_strains)
length(unique(pairs_clean_GC.df$sample_id))

paired_strains_not_in_clean <-setdiff(paired_strains, pairs_clean_GC.df$sample_id)
print(paste0(c("Pairs lacking: ", paired_strains_not_in_clean)))

paired_strains_not_in_clean.df <- data_frame(sample_id = paired_strains_not_in_clean) %>%
  mutate(number_of_replicates = 0)

pairs_clean_GC_nb_rep.df <- pairs_clean_GC.df %>%
  distinct(sample_id, well_id) %>%
  count(sample_id) %>%
  rename(number_of_replicates = n) %>%
  rbind(paired_strains_not_in_clean.df, .) %>%
  arrange(number_of_replicates) 

pairs_clean_GC_nb_rep.df %>%
  write.csv(x = ., file = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/dataframes/genetic_pairs_GC_replicate_per_strain.csv", row.names = F)

pairs_clean_GC_nb_rep.df %>% count(number_of_replicates)
```



## Print all strains with 0 to 4 replicates only
```{r}
pairs_clean_GC_nb_rep.df %>% filter(number_of_replicates <= 4)
```

## Plot comparison of GC kinetics for all pairs
```{r}

# filter pairs with members non screened yet
gen_pairs_done.df <- gen_pairs.df %>%
  filter(!iso1 %in% paired_strains_not_in_clean) %>%
  filter(!iso2 %in% paired_strains_not_in_clean) 

# set min max cell growth to scale plots
max_cd <- max(pairs_clean_GC.df$f_signal.fitted)
min_cd <- min(pairs_clean_GC.df$f_signal.fitted)


# create output dir
dir.create("Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots/genetic_pairs_comparison")

plot_list <- list()
for(i in 1:nrow(gen_pairs_done.df)) {
  iso1 <- gen_pairs_done.df$iso1[i]
  iso2 <- gen_pairs_done.df$iso2[i]
  iso1_mortality <- gen_pairs_done.df$iso1_mortality[i]
  iso2_mortality <- gen_pairs_done.df$iso2_mortality[i]
  pair_id <- gen_pairs_done.df$pair_id[i]
  dist <- gen_pairs_done.df$dist[i]
  
  plot_list[[pair_id]] <- pairs_clean_GC.df %>%
    filter(sample_id %in% c(iso1, iso2)) %>%
    ggplot(aes(x = timepoint/60, y = f_signal.fitted, colour = sample_id, group = sample_id, fill = sample_id)) +
    geom_point(size = .2) +
    stat_summary(geom = 'ribbon', fun.data = 'mean_sdl', fun.args = list(mult = 1), alpha = 0.2) +
    stat_summary(geom = "point", fun = "mean", size = 1.5) +
    labs(title = paste(iso1, iso2, "|", iso1_mortality, iso2_mortality, "|", dist),
         x = "Time (hour)",
         y = "OD") +
    theme_bw() +
    ylim(min_cd,max_cd)

  ggsave(plot = plot_list[[pair_id]], filename = paste0(dist, "_", pair_id, "_", iso1_mortality, "-", iso2_mortality,".jpeg"), device = "jpeg",  path = "Genetic_pairs_analysis_Oct_2020/processed_data/GC/QC_plots/genetic_pairs_comparison")
}

#cowplot::plot_grid(plotlist = plot_list)
```










